<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å¸æ©Ÿä»»å‹™</title>
  <style>
    :root{
      --bg:#070A14;
      --bg2:#0B1020;
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.62);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 24px rgba(0,0,0,.32);
      --accent: rgba(198, 170, 110, .95);
      --ice: rgba(140, 196, 255, .95);
      --good: rgba(98, 220, 165, .95);
      --warn: rgba(255, 196, 106, .95);
      --bad: rgba(255, 90, 90, .95);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      background:
        radial-gradient(900px 520px at 18% 0%, rgba(76,112,255,.22) 0%, rgba(7,10,20,0) 55%),
        radial-gradient(760px 460px at 88% 12%, rgba(198,170,110,.14) 0%, rgba(7,10,20,0) 58%),
        radial-gradient(700px 520px at 50% 110%, rgba(140,196,255,.10) 0%, rgba(7,10,20,0) 60%),
        linear-gradient(180deg, var(--bg2) 0%, var(--bg) 100%);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .topbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:14px;border:1px solid var(--line);border-radius:18px;
      background:rgba(18,26,51,.65);
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: var(--shadow2);
      position:relative;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .title{font-size:15px;font-weight:900;letter-spacing:.2px;margin:0}
    .brand .sub{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:8px 10px;border-radius:999px;
      font-size:12px;color:rgba(234,240,255,.92);
      white-space:nowrap;
    }

    select,button,input{
      border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10) 0%, rgba(255,255,255,.04) 100%);
      color:var(--text);
      padding:10px 12px;font-size:14px;
      outline:none;
      box-shadow: 0 1px 0 rgba(255,255,255,.12) inset, 0 10px 18px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    select{padding-right:34px}
    button{cursor:pointer;font-weight:900;letter-spacing:.2px}
    button:hover,input:hover,select:hover{
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 1px 0 rgba(255,255,255,.14) inset, 0 16px 26px rgba(0,0,0,.28);
      transform: translateY(-1px);
    }
    button:active,input:active,select:active{transform: translateY(0px)}
    button[disabled]{opacity:.55;cursor:not-allowed;transform:none}

    .grid{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .card{
      border:1px solid var(--line);border-radius:18px;
      background:rgba(18,26,51,.65);padding:14px;
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: var(--shadow);
      position:relative;
    }
    .card h2{
      font-size:14px;margin:0 0 10px;
      color:#cfe0ff;font-weight:900;letter-spacing:.2px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .muted{color:var(--muted);font-size:12px;line-height:1.55}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}

    .status{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dot{width:10px;height:10px;border-radius:999px;margin-top:4px;background:rgba(255,255,255,.30)}
    .dot.ok{background:rgba(98,220,165,.85)}
    .dot.warn{background:rgba(255,196,106,.85)}
    .dot.bad{background:rgba(255,90,90,.85)}
    .status .msg{font-size:13px;font-weight:800}
    .status .sub{font-size:12px;color:var(--muted);margin-top:2px}

    details{border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03);overflow:hidden}
    details+details{margin-top:8px}
    summary{
      cursor:pointer;list-style:none;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      gap:10px;
    }
    summary::-webkit-details-marker{display:none}

    .accBody{padding:10px;display:flex;flex-direction:column;gap:8px}
    .divider{height:1px;background: rgba(255,255,255,.10);margin:4px 0}

    .sumLeft{display:flex;flex-direction:column;gap:2px}
    .sumTitle{font-size:14px;font-weight:900;line-height:1.35;word-break:break-word;overflow-wrap:anywhere}
    .sumSub{font-size:12px;color:var(--muted);line-height:1.35;word-break:break-word;overflow-wrap:anywhere}
    .sumRight{font-size:16px;font-weight:900;white-space:nowrap}

    .miniRow{
      display:flex;align-items:flex-start;justify-content:space-between;
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04)
    }
    .miniLeft{display:flex;flex-direction:column;gap:2px}
    .miniTitle{font-size:13px;font-weight:900;line-height:1.35;word-break:break-word;overflow-wrap:anywhere}
    .miniSub{font-size:11px;color:var(--muted);line-height:1.35;word-break:break-word;overflow-wrap:anywhere}
    .miniNum{font-weight:900;white-space:nowrap}

    .task{
      display:grid;grid-template-columns:56px 1fr 70px;
      gap:8px;align-items:center;
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)
    }
    .tag{font-weight:900;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);text-align:center}
    .tag.h{background:rgba(255,90,90,.22);border-color:rgba(255,90,90,.30)}
    .tag.s{background:rgba(140,196,255,.18);border-color:rgba(140,196,255,.26)}
    .route .main{font-weight:900;line-height:1.35;word-break:break-word;overflow-wrap:anywhere}
    .route .sub{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.3;word-break:break-word;overflow-wrap:anywhere}
    .boards{font-weight:900;text-align:right;white-space:nowrap}

    .badgeArea{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(198,170,110,.28);
      background: rgba(198,170,110,.10);
      font-size:12px;font-weight:900;
    }
    .seq{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:34px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(140,196,255,.22);
      background: rgba(140,196,255,.10);
      font-weight:900;font-size:12px;
      margin-right:6px;
    }

    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:900px){.twoCol{grid-template-columns:1fr}}

    .form{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .form input{min-width:220px;flex:1}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="title">å¸æ©Ÿä»Šæ—¥ä»»å‹™</div>
        <div class="sub" id="subtitle">æ­£åœ¨åˆå§‹åŒ–â€¦</div>
      </div>
      <div class="spacer"></div>
      <div class="pill" id="pillUser">LINEï¼šæœªç™»å…¥</div>
      <div class="pill" id="pillDate">æ—¥æœŸï¼šâ€”</div>
    </div>

    <div class="grid">

      <!-- Status -->
      <div class="card" id="cardStatus">
        <h2>ç‹€æ…‹</h2>
        <div class="status" id="statusBox">
          <div class="dot" id="statusDot"></div>
          <div>
            <div class="msg" id="statusMsg">åˆå§‹åŒ–ä¸­â€¦</div>
            <div class="sub" id="statusSub">è«‹ç¨å€™</div>
          </div>
        </div>
      </div>

      <!-- Bind (only when needed) -->
      <div class="card" id="cardBind" style="display:none;">
        <h2>é¦–æ¬¡ç¶å®š</h2>
        <div class="muted">
          è‹¥ä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè«‹è¼¸å…¥ä½ çš„<strong>å¸æ©Ÿå§“å</strong>å®Œæˆç¶å®šã€‚<br/>
          ç³»çµ±æœƒ<strong>å¿½ç•¥å§“åå¾Œçš„æ•¸å­—</strong>ï¼ˆä¾‹å¦‚ã€Œå°è•™5ã€ç­‰åŒã€Œå°è•™ã€ï¼‰ã€‚
        </div>
        <div style="height:10px"></div>
        <div class="form">
          <input id="inpName" placeholder="ä¾‹å¦‚ï¼šå°è•™ æˆ– å°è•™5ï¼ˆç³»çµ±æœƒè‡ªå‹•å¿½ç•¥æ•¸å­—ï¼‰" />
          <button id="btnBind">å®Œæˆç¶å®š</button>
        </div>
        <div style="height:10px"></div>
        <div class="muted">è‹¥ç¶å®šå¤±æ•—ï¼Œè«‹è¯çµ¡èª¿åº¦ç¢ºèªã€Œå¸æ©Ÿå°ç…§ã€æ˜¯å¦å·²æœ‰ä½ çš„å§“åã€‚</div>
      </div>

      <!-- Date -->
      <div class="card" id="cardDate" style="display:none;">
        <h2>æ—¥æœŸ</h2>
        <div class="row">
          <div class="muted" id="todayLine">ä»Šå¤©ï¼šâ€”</div>
          <div class="right"></div>
          <select id="selDate"></select>
          <button id="btnReload">æ›´æ–°ä»»å‹™</button>
        </div>
      </div>

      <!-- Transfer -->
      <div class="card" id="cardTransfer" style="display:none;">
        <h2>ğŸšš è½‰é‹ä»»å‹™</h2>
        <div id="transferList"></div>
        <div class="muted" id="transferEmpty" style="display:none;">ä»Šæ—¥æ²’æœ‰è½‰é‹ä»»å‹™</div>
      </div>

      <!-- Area -->
      <div class="card" id="cardArea" style="display:none;">
        <h2>
          <span>ğŸŸ£ å€é…ä»»å‹™</span>
          <span class="badgeArea">ä¸»é¡¯ç¤ºï¼šæ”¶ä»¶äººï½œé»é–‹çœ‹åœ°å€</span>
        </h2>
        <div id="areaList"></div>
        <div class="muted" id="areaEmpty" style="display:none;">ä»Šæ—¥æ²’æœ‰å€é…ä»»å‹™</div>
      </div>

    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // ====== CONFIG ======
    const LIFF_ID = "2008915809-vp9PFMVX";
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxY-cAz9uSlEo44YA7GAp6DYtAog3VTxLWWSAesQKiok2w2HxkOVOe_UnhNw5nV9K5C/exec";

    // ====== DOM ======
    const el = (id)=>document.getElementById(id);
    const safeText = (v)=> (v===null||v===undefined) ? "" : String(v);
    const num = (v)=> Number(v||0);

    function setStatus(kind, msg, sub){
      el("statusDot").className = "dot " + (kind||"");
      el("statusMsg").textContent = msg || "";
      el("statusSub").textContent = sub || "";
    }
    function setSubtitle(t){ el("subtitle").textContent = t; }

    function setLoading(on){
      el("btnReload").disabled = on;
      el("btnBind").disabled = on;
      el("btnReload").textContent = on ? "æ›´æ–°ä¸­â€¦" : "æ›´æ–°ä»»å‹™";
      el("btnBind").textContent = on ? "è™•ç†ä¸­â€¦" : "å®Œæˆç¶å®š";
    }

    // ====== JSONP ======
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const timeout = setTimeout(()=>{
          cleanup();
          reject(new Error("é€£ç·šé€¾æ™‚"));
        }, 12000);

        function cleanup(){
          clearTimeout(timeout);
          if (s && s.parentNode) s.parentNode.removeChild(s);
          try{ delete window[cbName]; }catch(_){}
        }

        window[cbName] = (data)=>{
          cleanup();
          resolve(data);
        };

        const sep = url.includes("?") ? "&" : "?";
        s.src = url + sep + "callback=" + encodeURIComponent(cbName);
        s.onerror = ()=>{
          cleanup();
          reject(new Error("è¼‰å…¥å¤±æ•—"));
        };

        document.body.appendChild(s);
      });
    }

    // ====== utils ======
    function gradeClass(g){
      const v = safeText(g).toUpperCase();
      if (v === "H") return "h";
      return "s";
    }

    // å–å§“åæœ«å°¾æ•¸å­—é †åºï¼ˆä¾‹å¦‚ "å°è•™5" -> {name:"å°è•™", seq:5}ï¼‰
    function trailingSeq(name){
      const raw = safeText(name).trim();
      if (!raw) return { name:"", seq:null };
      const m = raw.match(/^(.*?)([0-9ï¼-ï¼™]+)$/);
      if (!m) return { name: raw, seq:null };
      const base = (m[1] || "").trim();
      const digits = (m[2] || "").replace(/[ï¼-ï¼™]/g, d => String("ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™".indexOf(d)));
      const seq = Number(digits);
      return { name: base, seq: Number.isFinite(seq) ? seq : null };
    }
    function displaySeq(seq){
      const n = Number(seq);
      return Number.isFinite(n) ? String(n) : "";
    }
    function seqSortValue(seq){
      const n = Number(seq);
      return Number.isFinite(n) ? n : 999999;
    }

    // ====== render ======
    function renderTransfer(daily){
      const list = el("transferList");
      list.innerHTML = "";

      const arr = (daily && daily.block2 && daily.block2.transferDrivers) ? daily.block2.transferDrivers : [];
      const me = safeText(daily && daily.driverName).trim();

      // transferDrivers æ˜¯å…¨å“¡åˆ—è¡¨ï¼Œå¸æ©Ÿç«¯åªé¡¯ç¤ºè‡ªå·±çš„
      const mine = arr.find(x => safeText(x.driver).trim() === me);
      const items = mine ? (mine.items || []) : [];

      el("transferEmpty").style.display = items.length ? "none" : "block";

      // ä¾æè²¨åˆ†çµ„
      const byPickup = new Map();
      items.forEach(t=>{
        const k = safeText(t.pickup);
        if(!byPickup.has(k)) byPickup.set(k, []);
        byPickup.get(k).push(t);
      });

      Array.from(byPickup.entries()).forEach(([pickup, tasks])=>{
        const det = document.createElement("details");
        det.open = true;

        const subtotal = tasks.reduce((s,x)=>s+num(x.boards),0);
        const sum = document.createElement("summary");
        sum.innerHTML = `
          <div class="sumLeft">
            <div class="sumTitle">${safeText(pickup)}ï¼ˆè½‰é‹ï¼‰</div>
            <div class="sumSub">å…± ${tasks.length} ç­†</div>
          </div>
          <div class="sumRight">${subtotal} ç‰ˆ</div>
        `;
        det.appendChild(sum);

        const body = document.createElement("div");
        body.className = "accBody";

        (tasks || []).forEach(t=>{
          const tag = safeText(t.grade).toUpperCase() === "H" ? "H" : "S";
          const metaParts = [];
          if (t.carNo) metaParts.push(`è»Šè™Ÿ:${safeText(t.carNo)}`);
          if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
          if (t.note)  metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
          const sub = metaParts.join(" ï½œ ");

          const div = document.createElement("div");
          div.className = "task";
          div.innerHTML = `
            <div class="tag ${gradeClass(tag)}">${tag}</div>
            <div class="route">
              <div class="main">${safeText(t.pickup)} â†’ ${safeText(t.dropoff)}</div>
              <div class="sub">${sub}</div>
            </div>
            <div class="boards">${num(t.boards)} ç‰ˆ</div>
          `;
          body.appendChild(div);
        });

        det.appendChild(body);
        list.appendChild(det);
      });
    }

    function renderArea(daily){
      const list = el("areaList");
      list.innerHTML = "";

      const arr = (daily && daily.block2 && daily.block2.areaDrivers) ? daily.block2.areaDrivers : [];
      const me = safeText(daily && daily.driverName).trim();

      // areaDrivers æ˜¯å…¨å“¡åˆ—è¡¨ï¼Œå¸æ©Ÿç«¯åªé¡¯ç¤ºè‡ªå·±çš„
      const mine = arr.find(x => safeText(x.driver).trim() === me);
      const itemsRaw = mine ? (mine.items || []) : [];

      el("areaEmpty").style.display = itemsRaw.length ? "none" : "block";

      // ä¾ seq æ’åºï¼ˆæœ‰é †åºå…ˆã€ç„¡é †åºå¾Œï¼‰
      const items = itemsRaw.slice().sort((a,b)=>{
        const sa = seqSortValue(a.seq);
        const sb = seqSortValue(b.seq);
        if (sa !== sb) return sa - sb;
        return num(b.boards) - num(a.boards);
      });

      // ä¾æè²¨é»åˆ†çµ„ï¼ˆæ›´å¥½çœ‹ï¼‰
      const byPickup = new Map();
      items.forEach(x=>{
        const k = safeText(x.pickup);
        if(!byPickup.has(k)) byPickup.set(k, []);
        byPickup.get(k).push(x);
      });

      Array.from(byPickup.entries()).forEach(([pickup, arr])=>{
        const det = document.createElement("details");
        det.open = true;

        const subtotal = arr.reduce((s,x)=>s+num(x.boards),0);
        const sum = document.createElement("summary");
        sum.innerHTML = `
          <div class="sumLeft">
            <div class="sumTitle">${safeText(pickup)}ï¼ˆå€é…ï¼‰</div>
            <div class="sumSub">å…± ${arr.length} ç­†</div>
          </div>
          <div class="sumRight">${subtotal} ç‰ˆ</div>
        `;
        det.appendChild(sum);

        const body = document.createElement("div");
        body.className = "accBody";

        arr.forEach(x=>{
          // ä¸»é¡¯ç¤ºï¼šE â†’ Kï¼ˆæ”¶ä»¶äººï¼‰
          const mainLine = `${safeText(x.pickup)} â†’ ${safeText(x.dropoff)}`;
          const tag = safeText(x.grade).toUpperCase() === "H" ? "H" : "S";
          const metaParts = [];
          if (x.carNo) metaParts.push(`è»Šè™Ÿ:${safeText(x.carNo)}`);
          if (x.owner) metaParts.push(`è²¨ä¸»:${safeText(x.owner)}`);
          if (x.note)  metaParts.push(`å‚™è¨»:${safeText(x.note)}`);
          const sub = metaParts.join(" ï½œ ");

          const inner = document.createElement("details");
          inner.className = "acc";

          const seq = displaySeq(x.seq);
          const sum2 = document.createElement("summary");
          sum2.innerHTML = `
            <div class="sumLeft">
              <div class="sumTitle">${seq ? `<span class="seq">#${seq}</span>` : ""}${mainLine}</div>
              <div class="sumSub">${sub || "é»é–‹çœ‹ï¼šå€é…æè²¨åœ°å€ / æ”¶ä»¶äººåœ°å€"}</div>
            </div>
            <div class="sumRight">${num(x.boards)} ç‰ˆ</div>
          `;
          inner.appendChild(sum2);

          const body2 = document.createElement("div");
          body2.className = "accBody";

          const a1 = document.createElement("div");
          a1.className = "miniRow";
          a1.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ“ å€é…æè²¨åœ°å€</div>
              <div class="miniSub">${safeText(x.pickupAddr) || "ï¼ˆæœªå¡«ï¼‰"}</div>
            </div>
          `;
          body2.appendChild(a1);

          const a2 = document.createElement("div");
          a2.className = "miniRow";
          a2.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ  æ”¶ä»¶äººåœ°å€</div>
              <div class="miniSub">${safeText(x.recvAddr) || "ï¼ˆæœªå¡«ï¼‰"}</div>
            </div>
          `;
          body2.appendChild(a2);

          inner.appendChild(body2);
          body.appendChild(inner);
        });

        det.appendChild(body);
        list.appendChild(det);
      });
    }

    function showCards(hasData){
      el("cardDate").style.display = hasData ? "block" : "none";
      el("cardTransfer").style.display = hasData ? "block" : "none";
      el("cardArea").style.display = hasData ? "block" : "none";
    }

    // ====== data flow ======
    let LINE_UID = "";
    let OPTIONS = null; // date options from GAS
    let CHOSEN = "";

    async function loadDaily(dateTab){
      if (!LINE_UID) throw new Error("å°šæœªå–å¾— LINE userId");

      const dt = dateTab ? String(dateTab) : "";
      const url = `${GAS_EXEC_URL}?mode=api_jsonp&uid=${encodeURIComponent(LINE_UID)}&date=${encodeURIComponent(dt)}`;

      setLoading(true);
      try{
        const payload = await jsonp(url);

        if (!payload || payload.ok === false){
          const msg = payload && payload.message ? payload.message : "ç›®å‰ç„¡æ³•è®€å–ä»»å‹™";
          // æœªç¶å®šï¼šé¡¯ç¤ºç¶å®šå¡
          if (msg.includes("å°šæœªç¶å®š")){
            setStatus("warn", "å°šæœªç¶å®š", "è«‹å…ˆå®Œæˆé¦–æ¬¡ç¶å®šï¼ˆè¼¸å…¥å§“åï¼‰");
            el("cardBind").style.display = "block";
            showCards(false);
            return;
          }
          setStatus("bad", "è®€å–å¤±æ•—", msg);
          el("cardBind").style.display = "none";
          showCards(false);
          return;
        }

        // æˆåŠŸ
        el("cardBind").style.display = "none";
        setStatus("ok", "å·²è¼‰å…¥", "å¯åˆ‡æ›æ—¥æœŸæŸ¥çœ‹ä»»å‹™");
        showCards(true);

        OPTIONS = payload.options || null;
        CHOSEN = payload.chosenDate || "";
        el("pillDate").textContent = `åˆ†é ï¼š${CHOSEN || "â€”"}`;

        // æ—¥æœŸ UIï¼ˆäº”å¤©ï¼‰
        buildDateSelect(OPTIONS, CHOSEN);

        // é¡¯ç¤ºã€Œä»Šå¤©ã€
        el("todayLine").textContent = OPTIONS && OPTIONS.baseToday
          ? `ä»Šå¤©ï¼š${OPTIONS.baseToday}`
          : `ä»Šå¤©ï¼šâ€”`;

        // æ¨™é¡Œ
        setSubtitle(`å¸æ©Ÿï¼š${safeText(payload.driverName)}ï½œåˆ†é ï¼š${safeText(CHOSEN)}`);

        // renderï¼ˆå¾Œç«¯è¦å› block2.areaDriversï¼‰
        renderTransfer(payload);
        renderArea(payload);
      } finally {
        setLoading(false);
      }
    }

    function buildDateSelect(opt, chosen){
      const sel = el("selDate");
      sel.innerHTML = "";

      // 5 å¤©è¦–çª—ï¼ˆä¸å­˜åœ¨çš„ä¸è¦é¡¯ç¤ºï¼‰
      const entries = [
        ["D-2", opt && opt.dMinus2],
        ["D-1", opt && opt.dMinus1],
        ["D",   opt && opt.d],
        ["D+1", opt && opt.dPlus1],
        ["D+2", opt && opt.dPlus2],
      ].filter(x => x[1]);

      entries.forEach(([label, tab])=>{
        const o = document.createElement("option");
        o.value = tab;
        o.textContent = `${label}ï¼ˆ${tab}ï¼‰`;
        sel.appendChild(o);
      });

      // é è¨­ D
      const dTab = opt && opt.d ? String(opt.d) : "";
      const want = chosen ? String(chosen) : dTab;
      const idx = Array.from(sel.options).findIndex(o => o.value === want);
      sel.selectedIndex = idx >= 0 ? idx : 0;
    }

    async function doBind(){
      if (!LINE_UID) throw new Error("å°šæœªå–å¾— LINE userId");
      const name = safeText(el("inpName").value).trim();
      if (!name){
        setStatus("warn", "è«‹è¼¸å…¥å§“å", "ä¾‹å¦‚ï¼šå°è•™ï¼ˆç³»çµ±æœƒå¿½ç•¥æ•¸å­—ï¼‰");
        return;
      }

      const url = `${GAS_EXEC_URL}?mode=bind_jsonp&uid=${encodeURIComponent(LINE_UID)}&driverName=${encodeURIComponent(name)}`;
      setLoading(true);
      try{
        const payload = await jsonp(url);
        if (!payload || payload.ok === false){
          setStatus("bad", "ç¶å®šå¤±æ•—", (payload && payload.message) ? payload.message : "è«‹ç¨å¾Œå†è©¦");
          return;
        }
        setStatus("ok", "ç¶å®šæˆåŠŸ", "å·²å®Œæˆç¶å®šï¼Œæ­£åœ¨è¼‰å…¥ä»»å‹™â€¦");
        el("cardBind").style.display = "none";
        await loadDaily(""); // é‡æ–°è®€ä»»å‹™ï¼ˆé è¨­ Dï¼‰
      } finally {
        setLoading(false);
      }
    }

    // ====== init ======
    async function init(){
      setStatus("", "åˆå§‹åŒ–ä¸­â€¦", "æ­£åœ¨é€£ç·š LINE");
      try{
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()){
          setSubtitle("éœ€è¦ç™»å…¥ LINE");
          liff.login({ redirectUri: location.href });
          return;
        }

        const p = await liff.getProfile();
        LINE_UID = p && p.userId ? p.userId : "";
        el("pillUser").textContent = LINE_UID ? `LINEï¼šå·²ç™»å…¥` : `LINEï¼šæœªå–å¾—`;
        setSubtitle("æ­£åœ¨è®€å–ä»»å‹™â€¦");

        // åˆæ¬¡è®€å–ï¼ˆé è¨­ Dï¼‰
        await loadDaily("");

      } catch(err){
        setStatus("bad", "åˆå§‹åŒ–å¤±æ•—", err && err.message ? err.message : String(err));
        setSubtitle("åˆå§‹åŒ–å¤±æ•—");
      }
    }

    // events
    el("btnBind").addEventListener("click", ()=>{ doBind().catch(e=>setStatus("bad","ç¶å®šå¤±æ•—",e.message||String(e))); });
    el("btnReload").addEventListener("click", ()=>{
      const dt = el("selDate").value;
      loadDaily(dt).catch(e=>setStatus("bad","è®€å–å¤±æ•—",e.message||String(e)));
    });
    el("selDate").addEventListener("change", ()=>{
      const dt = el("selDate").value;
      loadDaily(dt).catch(e=>setStatus("bad","è®€å–å¤±æ•—",e.message||String(e)));
    });

    init();
  </script>
</body>
</html>


