<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>司機任務</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --bd:rgba(255,255,255,.10);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --muted2:#a3a3a3;
      --ok:#86efac;
      --warn:#fde68a;
      --err:#fecaca;
      --btn:rgba(255,255,255,.10);
      --btnbd:rgba(255,255,255,.14);
      --chip:rgba(255,255,255,.10);
      --chipbd:rgba(255,255,255,.12);
    }
    body{margin:0;font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:920px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:14px;margin-bottom:12px;}
    .top{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .title{font-size:18px;font-weight:900;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;line-height:1.5;margin-top:4px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .pill{background:var(--chip);border:1px solid var(--chipbd);padding:7px 10px;border-radius:999px;font-size:13px;}
    .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    input{min-width:220px}
    button{
      background:var(--btn);
      border:1px solid var(--btnbd);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      font-weight:800;
    }
    button:disabled{opacity:.55;cursor:not-allowed;}
    .msg{margin-top:10px;font-size:13px;line-height:1.6;color:var(--muted2)}
    .msg.ok{color:var(--ok)}
    .msg.warn{color:var(--warn)}
    .msg.err{color:var(--err)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .sectionTitle{font-size:14px;font-weight:900;margin-bottom:6px}
    details{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px;margin-top:10px;}
    summary{cursor:pointer;font-weight:900;}
    .task{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08);}
    .task:last-child{border-bottom:0;}
    .big{font-size:16px;font-weight:900;}
    .muted{color:var(--muted);font-size:13px;line-height:1.5;word-break:break-all}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px;}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);
    }
    .hide{display:none !important;}
  </style>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="wrap">

  <!-- HEADER / STATUS -->
  <div class="card">
    <div class="top">
      <div>
        <div class="title">司機任務</div>
        <div class="sub" id="subtitle">載入中…</div>
      </div>
      <div class="right">
        <span class="badge" id="badgeEnv">LINE</span>
        <span class="badge" id="badgeDate">—</span>
      </div>
    </div>

    <!-- 操作列（已綁定才會顯示） -->
    <div class="row hide" id="topRow">
      <div class="pill" id="pillDriver">司機：—</div>
      <div class="pill" id="pillToday">今天：—</div>

      <label class="muted">日期：</label>
      <select id="dateSelect"></select>

      <button id="refreshBtn" type="button">重新整理</button>
    </div>

    <!-- 精簡訊息 -->
    <div class="msg hide" id="msgBox"></div>

    <!-- Debug（可關） -->
    <div class="muted hide" id="debugBox" style="margin-top:10px;"></div>
  </div>

  <!-- BIND UI（未綁定時顯示） -->
  <div class="card hide" id="bindCard">
    <div class="sectionTitle">首次使用：請完成綁定</div>
    <div class="muted">
      請輸入你的姓名（會 <b>忽略前後數字</b> 來比對，例如：<code>5王小明1</code> 也能用 <code>王小明</code> 綁定）。
      綁定後你只會看到自己的任務。
    </div>

    <div class="row" style="margin-top:12px;">
      <input id="bindName" type="text" placeholder="例如：王小明（姓名(轉)）" autocomplete="off" />
      <button id="bindBtn" type="button">一鍵綁定</button>
      <button id="bindHelpBtn" type="button">我不知道要填什麼</button>
    </div>

    <div class="msg warn hide" id="bindHelp">
      你要填的是「每日車趟分頁」裡的 <b>姓名(轉)</b>（輸入時會自動忽略數字）。
      如果你不確定，請回報給管理員確認表內名字。
    </div>

    <div class="divider"></div>
    <div class="muted">
      若仍無法綁定，請提供這段給管理員：<br/>
      <span id="bindUidLine"></span>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="content"></div>

  <!-- FOOTER -->
  <div class="card">
    <div class="muted">
      提醒：如果今天沒有任務，可能是今日未派單，或你的姓名尚未出現在當日分頁。
    </div>
  </div>

</div>

<script>
  // ===== 確認這兩行是你的 =====
  const LIFF_ID = "2008915809-vp9PFMVX";
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxY-cAz9uSlEo44YA7GAp6DYtAog3VTxLWWSAesQKiok2w2HxkOVOe_UnhNw5nV9K5C/exec";

  // 想更「乾淨」就設 false（不顯示 userId）
  const SHOW_USER_ID = true;

  let currentUserId = null;
  let isLoading = false;

  const subtitleEl = document.getElementById("subtitle");
  const msgBoxEl = document.getElementById("msgBox");
  const debugBoxEl = document.getElementById("debugBox");

  const topRowEl = document.getElementById("topRow");
  const contentEl = document.getElementById("content");

  const bindCardEl = document.getElementById("bindCard");
  const bindNameEl = document.getElementById("bindName");
  const bindBtnEl = document.getElementById("bindBtn");
  const bindHelpBtnEl = document.getElementById("bindHelpBtn");
  const bindHelpEl = document.getElementById("bindHelp");
  const bindUidLineEl = document.getElementById("bindUidLine");

  const badgeDateEl = document.getElementById("badgeDate");

  function setLoading(on){
    isLoading = !!on;
    const btn = document.getElementById("refreshBtn");
    const sel = document.getElementById("dateSelect");
    if (btn) btn.disabled = isLoading;
    if (sel) sel.disabled = isLoading;
    bindBtnEl.disabled = isLoading;
  }

  function showMsg(type, text){
    if (!text){
      msgBoxEl.classList.add("hide");
      msgBoxEl.textContent = "";
      msgBoxEl.className = "msg hide";
      return;
    }
    msgBoxEl.classList.remove("hide");
    msgBoxEl.className = "msg " + (type || "");
    msgBoxEl.textContent = text;
  }

  function setDebug(html){
    if (!SHOW_USER_ID){
      debugBoxEl.classList.add("hide");
      debugBoxEl.innerHTML = "";
      return;
    }
    debugBoxEl.classList.remove("hide");
    debugBoxEl.innerHTML = html || "";
  }

  function showBindUI(on){
    if (on) bindCardEl.classList.remove("hide");
    else bindCardEl.classList.add("hide");
  }

  function showTopRow(on){
    if (on) topRowEl.classList.remove("hide");
    else topRowEl.classList.add("hide");
  }

  // ✅ 忽視數字：顯示 / 比對
  function normalizeDriverName(name){
    return String(name || "")
      .trim()
      .replace(/\s+/g, "")
      .replace(/[0-9０-９]/g, "")
      .toLowerCase();
  }
  function prettyDriverName(name){
    return String(name || "")
      .trim()
      .replace(/[0-9０-９]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  // ===== JSONP 共用 =====
  function jsonpCall(params){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cbName] = (data) => { cleanup(); resolve(data); };

      function cleanup(){
        try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      script.onerror = () => { cleanup(); reject(new Error("連線失敗，請稍後重試")); };

      const usp = new URLSearchParams({ ...params, callback: cbName });
      script.src = GAS_EXEC_URL + "?" + usp.toString();
      document.head.appendChild(script);
    });
  }

  function callApiDaily(uid, date){
    return jsonpCall({ mode:"api_jsonp", uid: uid||"", date: date||"" });
  }
  function callBind(uid, driverName){
    return jsonpCall({ mode:"bind_jsonp", uid: uid||"", driverName: driverName||"" });
  }

  function buildFiveDayItems(options){
    const out = [];
    if (options?.dMinus2) out.push({ label: `D-2（${options.dMinus2}）`, value: options.dMinus2 });
    if (options?.dMinus1) out.push({ label: `D-1（${options.dMinus1}）`, value: options.dMinus1 });
    if (options?.d)       out.push({ label: `D（${options.d}）`, value: options.d });
    if (options?.dPlus1)  out.push({ label: `D+1（${options.dPlus1}）`, value: options.dPlus1 });
    if (options?.dPlus2)  out.push({ label: `D+2（${options.dPlus2}）`, value: options.dPlus2 });
    return out;
  }

  function fillDateSelect(options, chosen){
    const sel = document.getElementById("dateSelect");
    sel.innerHTML = "";

    const items = buildFiveDayItems(options);
    const values = new Set(items.map(x => x.value));
    const finalChosen = values.has(chosen) ? chosen : (options?.d || chosen);

    for (const it of items){
      const opt = document.createElement("option");
      opt.value = it.value;
      opt.textContent = it.label;
      if (it.value === finalChosen) opt.selected = true;
      sel.appendChild(opt);
    }

    sel.onchange = () => fetchDaily(sel.value);
  }

  function looksUnboundMessage(msg){
    const m = String(msg || "");
    return m.includes("尚未綁定") || m.includes("未綁定司機") || m.includes("enabled");
  }

  function renderDaily(driverName, chosenDate, baseToday, daily){
    showBindUI(false);
    showTopRow(true);

    document.getElementById("pillDriver").textContent = `司機：${prettyDriverName(driverName)}`;
    document.getElementById("pillToday").textContent  = `今天：${baseToday || "-"}｜查看：${chosenDate}`;
    badgeDateEl.textContent = baseToday ? `Today ${baseToday}` : "—";

    subtitleEl.textContent = "已載入";
    showMsg("", "");

    // ✅ 用「忽視數字」比對抓自己的群組
    const target = normalizeDriverName(driverName);
    const d = (daily.block2?.transferDrivers || []).find(x => normalizeDriverName(x.driver) === target);
    const items = d?.items || [];

    contentEl.innerHTML = "";

    if (!items.length){
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<div class="big">今天沒有任務</div>
                     <div class="muted" style="margin-top:6px;">可能是今日未派單，或你的姓名尚未出現在當日分頁。</div>`;
      contentEl.appendChild(c);
      return;
    }

    // 分提貨倉顯示
    const byPickup = new Map();
    for (const it of items){
      const k = it.pickup || "(未填提貨)";
      if (!byPickup.has(k)) byPickup.set(k, []);
      byPickup.get(k).push(it);
    }

    for (const [pickup, arr] of byPickup.entries()){
      const card = document.createElement("div");
      card.className = "card";

      const totalBoards = arr.reduce((s,x)=>s + Number(x.boards||0), 0);

      card.innerHTML = `
        <div class="top">
          <div>
            <div class="big">${pickup}</div>
            <div class="sub">共 ${arr.length} 筆｜合計 ${totalBoards} 版</div>
          </div>
        </div>
      `;

      const det = document.createElement("details");
      det.open = true;
      const sum = document.createElement("summary");
      sum.textContent = "展開 / 收合明細";
      det.appendChild(sum);

      for (const it of arr){
        const t = document.createElement("div");
        t.className = "task";

        const main = `${it.pickup || ""} → ${it.dropoff || ""}　${it.boards ?? ""}版`;
        const meta1 = `等級：${it.grade || ""}　車號：${it.carNo || ""}`;
        const meta2 = it.owner ? `貨主：${it.owner}` : "";
        const meta3 = it.note ? `備註：${it.note}` : "";

        t.innerHTML = `
          <div style="font-weight:900">${main}</div>
          <div class="muted">${meta1}${meta2 ? "｜" + meta2 : ""}</div>
          ${meta3 ? `<div class="muted">${meta3}</div>` : ""}
        `;
        det.appendChild(t);
      }

      card.appendChild(det);
      contentEl.appendChild(card);
    }
  }

  async function fetchDaily(dateTab){
    if (!currentUserId) {
      showMsg("err", "尚未取得 LINE 身分，請稍後重試");
      return;
    }

    setLoading(true);
    subtitleEl.textContent = "讀取任務中…";
    showMsg("", "");

    try{
      const res = await callApiDaily(currentUserId, dateTab || "");

      if (!res || res.ok === false) {
        const msg = res?.message || "讀取失敗";

        // 未綁定：顯示綁定 UI
        if (looksUnboundMessage(msg)){
          showTopRow(false);
          showBindUI(true);
          subtitleEl.textContent = "尚未綁定";
          showMsg("warn", "首次使用請完成綁定：輸入姓名(轉) 後按「一鍵綁定」。");
          contentEl.innerHTML = "";

          bindUidLineEl.innerHTML = SHOW_USER_ID
            ? `lineUserId：<code>${currentUserId}</code>`
            : `lineUserId：<code>（已隱藏）</code>`;

          setDebug(SHOW_USER_ID ? `lineUserId：<code>${currentUserId}</code>` : "");
          return;
        }

        subtitleEl.textContent = "讀取失敗";
        showMsg("err", "目前無法讀取任務，請稍後再試或聯絡管理員。");
        setDebug(SHOW_USER_ID ? `錯誤：<code>${msg}</code><br/>lineUserId：<code>${currentUserId}</code>` : "");
        return;
      }

      fillDateSelect(res.options, res.chosenDate);
      setDebug(SHOW_USER_ID ? `lineUserId：<code>${currentUserId}</code>` : "");
      renderDaily(res.driverName, res.chosenDate, res.options?.baseToday, res.daily);

    } catch(e){
      subtitleEl.textContent = "讀取失敗";
      showMsg("err", "連線失敗，請稍後再試。");
      setDebug(SHOW_USER_ID ? `錯誤：<code>${(e?.message || e)}</code><br/>lineUserId：<code>${currentUserId || ""}</code>` : "");
    } finally {
      setLoading(false);
    }
  }

  async function doBind(){
    const name = String(bindNameEl.value || "").trim();
    if (!name){
      showMsg("warn", "請先輸入姓名（會忽略數字比對）");
      bindNameEl.focus();
      return;
    }

    if (!currentUserId){
      showMsg("err", "尚未取得 LINE 身分，請返回重開一次");
      return;
    }

    setLoading(true);
    showMsg("", "");
    subtitleEl.textContent = "綁定中…";

    try{
      const res = await callBind(currentUserId, name);

      if (!res || res.ok === false){
        const msg = res?.message || "綁定失敗";
        subtitleEl.textContent = "綁定失敗";
        showMsg("err", msg);
        setDebug(SHOW_USER_ID ? `綁定錯誤：<code>${msg}</code><br/>lineUserId：<code>${currentUserId}</code>` : "");
        return;
      }

      subtitleEl.textContent = "綁定成功";
      showMsg("ok", "綁定成功！正在載入你的任務…");

      await fetchDaily("");

    } catch(e){
      subtitleEl.textContent = "綁定失敗";
      showMsg("err", "綁定連線失敗，請稍後再試。");
      setDebug(SHOW_USER_ID ? `錯誤：<code>${(e?.message || e)}</code><br/>lineUserId：<code>${currentUserId || ""}</code>` : "");
    } finally {
      setLoading(false);
    }
  }

  async function main(){
    try{
      document.getElementById("badgeEnv").textContent = "LINE";

      if (typeof liff === "undefined") {
        subtitleEl.textContent = "無法載入";
        showMsg("err", "LIFF 無法載入，請檢查網路後重試。");
        return;
      }

      subtitleEl.textContent = "初始化中…";
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()){
        subtitleEl.textContent = "需要登入…";
        liff.login({ redirectUri: location.href });
        return;
      }

      subtitleEl.textContent = "取得身分中…";
      const profile = await liff.getProfile();
      currentUserId = profile.userId;

      bindUidLineEl.innerHTML = SHOW_USER_ID
        ? `lineUserId：<code>${currentUserId}</code>`
        : `lineUserId：<code>（已隱藏）</code>`;

      document.getElementById("refreshBtn").onclick = () => {
        const sel = document.getElementById("dateSelect");
        const date = sel && sel.value ? sel.value : "";
        fetchDaily(date);
      };
      bindBtnEl.onclick = doBind;
      bindHelpBtnEl.onclick = () => bindHelpEl.classList.toggle("hide");
      bindNameEl.addEventListener("keydown", (ev)=>{
        if (ev.key === "Enter") doBind();
      });

      await fetchDaily("");

    } catch(e){
      subtitleEl.textContent = "初始化失敗";
      showMsg("err", "初始化失敗，請稍後重試或聯絡管理員。");
      setDebug(SHOW_USER_ID ? `錯誤：<code>${(e?.message || e)}</code>` : "");
    }
  }

  main();
</script>
</body>
</html>

