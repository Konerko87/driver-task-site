<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>

  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">

  <style>
    /* ===== Driver page small layout ===== */
    .wrap{max-width:980px;margin:0 auto;padding:12px 12px 80px;}
    .topbar2{
      display:flex; align-items:flex-start; gap:10px;
      padding:12px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03); border-radius:14px;
      position:sticky; top:10px; z-index:50; backdrop-filter: blur(8px);
    }
    .titleBox{min-width:0; flex:1;}
    .titleBox .title{
      font-size:18px; font-weight:700; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .titleBox .sub{opacity:.8;font-size:12px;margin-top:4px;}
    .btnRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:inherit; border-radius:999px;
      padding:8px 10px; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .btn[disabled]{opacity:.45; cursor:not-allowed;}
    .btn.on{background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.22);}

    .card2{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      overflow:hidden;
    }
    .card2 h2{
      margin:0; padding:12px 12px;
      font-size:15px; border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; gap:8px;
    }
    .card2 .body{padding:12px;}
    .empty2{opacity:.65; padding:14px; text-align:center;}

    /* tasks */
    .task{
      display:grid; grid-template-columns:56px 1fr 70px;
      gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:8px 10px;
      margin-bottom:10px;
    }
    .tag{
      font-weight:700; font-size:12px;
      width:44px; text-align:center; padding:6px 0;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .tag.h{background:rgba(255, 99, 99, .15); border-color:rgba(255,99,99,.22);}
    .tag.s{background:rgba(255,255,255,.06);}
    .route{min-width:0;}
    .route .main{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-weight:700; font-size:13px;
    }
    .route .sub{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      opacity:.8; font-size:12px; margin-top:2px;
    }
    .boards{font-weight:800; text-align:right; font-size:13px;}

    /* area details task */
    .taskAcc{
      display:block;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      overflow:hidden;
      margin-bottom:10px;
    }
    .taskAcc summary{
      padding:8px 10px;
      display:grid;
      grid-template-columns:56px 1fr 70px;
      gap:8px;
      align-items:center;
      cursor:pointer;
      list-style:none;
    }
    .taskAcc summary::-webkit-details-marker{display:none;}
    .taskAcc summary .route{min-width:0;}
    .taskAcc summary .route .main{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-weight:700; font-size:13px;
    }
    .taskAcc summary .route .sub{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      opacity:.8; font-size:12px; margin-top:2px;
    }
    .taskAcc .accBody{
      padding:10px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .miniRow{display:flex; gap:10px; margin-bottom:10px;}
    .miniLeft{min-width:0; flex:1;}
    .miniTitle{font-weight:700; font-size:12px; opacity:.9;}
    .miniSub{
      margin-top:4px;
      font-size:12px;
      opacity:.85;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.35;
    }

    /* bind */
    .bindBox{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px;
    }
    .in{
      flex:1; min-width:200px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:10px; padding:10px 12px; color:inherit;
      outline:none;
    }
    .danger{color:#ffb4b4; opacity:.95;}
    .ok{color:#b4ffd6; opacity:.95;}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar2">
      <div class="titleBox">
        <div class="title" id="title">ğŸšš å¸æ©Ÿä»»å‹™</div>
        <div class="sub" id="subtitle">è¼‰å…¥ä¸­â€¦</div>
      </div>
      <div class="btnRow" id="dateBtns"></div>
    </div>

    <!-- bind card -->
    <div class="card2" id="bindCard" style="display:none;">
      <h2>ğŸ”— å°šæœªç¶å®šå¸æ©Ÿ</h2>
      <div class="body">
        <div class="danger" id="bindMsg"></div>
        <div class="bindBox">
          <input class="in" id="bindName" placeholder="è¼¸å…¥ä½ çš„å§“åï¼ˆç³»çµ±æœƒå¿½ç•¥æ•¸å­—ï¼‰" />
          <button class="btn" id="btnBind">å®Œæˆç¶å®š</button>
        </div>
        <div style="opacity:.75;font-size:12px;line-height:1.35;">
          ç¶å®šè¦å‰‡ï¼šå¿½ç•¥å§“åä¸­çš„æ•¸å­—ï¼ˆå«å…¨å½¢ï¼‰ï¼ŒåŒä¸€å€‹ LINE åªèƒ½ç¶ä¸€ä½å¸æ©Ÿã€‚
        </div>
      </div>
    </div>

    <!-- transfer -->
    <div class="card2" id="transferCard" style="display:none;">
      <h2>ğŸš› è½‰é‹ä»»å‹™ <span style="opacity:.75;font-weight:500;font-size:12px;" id="transferStat"></span></h2>
      <div class="body" id="transferBody"></div>
      <div class="empty2" id="noTransfer" style="display:none;">ä»Šå¤©æ²’æœ‰è½‰é‹ä»»å‹™</div>
    </div>

    <!-- area -->
    <div class="card2" id="areaCard" style="display:none;">
      <h2>ğŸŸ£ å€é…ä»»å‹™ <span style="opacity:.75;font-weight:500;font-size:12px;" id="areaStat"></span></h2>
      <div class="body" id="areaBody"></div>
      <div class="empty2" id="noArea" style="display:none;">ä»Šå¤©æ²’æœ‰å€é…ä»»å‹™</div>
    </div>

    <div class="card2" id="errCard" style="display:none;">
      <h2>âš ï¸ éŒ¯èª¤</h2>
      <div class="body">
        <div class="danger" id="errMsg"></div>
      </div>
    </div>

  </div>

<script>
  // ============================
  // JSONP helpers
  // ============================
  const safeText = (v) => (v === null || v === undefined) ? '' : String(v);
  const num = (v) => Number(v || 0);
  const el = (id) => document.getElementById(id);

  function gradeClass(g){
    const t = safeText(g).toUpperCase();
    if (t === 'H') return 'h';
    if (t === 'S') return 's';
    return 's';
  }

  function cleanReceiverLabel(v){
    const s = safeText(v).trim();
    if (!s) return '';
    if (s.startsWith('#')) return '';
    if (s === '999999') return '';
    return s;
  }

  function jsonp(url, cbName){
    return new Promise((resolve, reject)=>{
      const script = document.createElement('script');
      const name = cbName || ('cb_' + Date.now() + '_' + Math.floor(Math.random()*9999));
      const timer = setTimeout(()=>{
        cleanup();
        reject(new Error('JSONP timeout'));
      }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[name]; } catch(e) { window[name] = undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[name] = (data)=>{
        cleanup();
        resolve(data);
      };

      script.onerror = ()=>{
        cleanup();
        reject(new Error('JSONP load error'));
      };

      const bust = (url.includes('?') ? '&' : '?') + '_=' + Date.now();
      script.src = url + bust + '&callback=' + encodeURIComponent(name);
      document.body.appendChild(script);
    });
  }

  // ============================
  // GAS WebApp base URL
  // ä½ åªè¦æŠŠ driver.html æ”¾åœ¨åŒå€‹å°ˆæ¡ˆï¼Œé€™è£¡ç”¨ç›¸å° doGet URL å³å¯ã€‚
  // ============================
  function baseUrl(){
    // GAS HtmlService ä¸­ï¼Œgoogle.script.url.getLocation å¯ç”¨ï¼Œä½†é€™è£¡èµ°ä¿å®ˆï¼šç”¨ç•¶å‰é é¢ URL å»æ‰ query
    return location.href.split('?')[0];
  }

  // ============================
  // UID from LIFF or query
  // ============================
  function getUidFromQuery(){
    const u = new URL(location.href);
    const uid = u.searchParams.get('uid');
    return safeText(uid).trim();
  }
  function getDateFromQuery(){
    const u = new URL(location.href);
    const d = u.searchParams.get('date');
    return safeText(d).trim();
  }

  // ============================
  // Render
  // ============================
  function setTitle(driverName){
    const n = safeText(driverName).trim();
    el('title').textContent = n ? `ğŸšš ${n}ï½œä»Šæ—¥ä»»å‹™` : 'ğŸšš å¸æ©Ÿä»Šæ—¥ä»»å‹™';
  }

  function setSubtitle(text){
    el('subtitle').textContent = text || '';
  }

  function showError(msg){
    el('errCard').style.display = 'block';
    el('errMsg').textContent = safeText(msg);
  }

  function showBind(message){
    el('bindCard').style.display = 'block';
    el('bindMsg').textContent = safeText(message || 'å°šæœªç¶å®š');
  }

  function hideBind(){
    el('bindCard').style.display = 'none';
  }

  function renderDateButtons(options, chosen){
    const box = el('dateBtns');
    box.innerHTML = '';

    const items = [
      {key:'dMinus2', label:'D-2'},
      {key:'dMinus1', label:'D-1'},
      {key:'d', label:'D'},
      {key:'dPlus1', label:'D+1'},
      {key:'dPlus2', label:'D+2'},
    ];

    items.forEach(it=>{
      const tab = options ? options[it.key] : null;
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = it.label;
      b.disabled = !tab;
      if (tab && tab === chosen) b.classList.add('on');
      b.addEventListener('click', ()=>{
        if (!tab) return;
        loadDaily(tab);
      });
      box.appendChild(b);
    });
  }

  function renderTransfer(me){
    const items = (me && me.transfer && me.transfer.items) ? me.transfer.items : [];
    const total = (me && me.transfer) ? num(me.transfer.totalBoards) : 0;
    const count = (me && me.transfer) ? num(me.transfer.count) : 0;

    el('transferCard').style.display = 'block';
    el('transferStat').textContent = `ï¼ˆç­†æ•¸ ${count}ï½œç¸½ç‰ˆæ•¸ ${total}ï¼‰`;

    const body = el('transferBody');
    body.innerHTML = '';

    if (!items.length){
      el('noTransfer').style.display = 'block';
      return;
    }
    el('noTransfer').style.display = 'none';

    // è½‰é‹ï¼šé€™è£¡ items å·²æ˜¯åˆä½µå¾Œçš„ pickupâ†’dropoffï¼ˆä¾ä½  Code.gsï¼‰
    items.forEach(t=>{
      const tag = safeText(t.grade).toUpperCase() || 'S';
      const meta = [];
      if (t.carNo) meta.push('è»Šè™Ÿ:' + safeText(t.carNo));
      if (t.owner) meta.push('è²¨ä¸»:' + safeText(t.owner));
      if (t.note) meta.push('å‚™è¨»:' + safeText(t.note));
      const sub = meta.join(' ï½œ ');

      const row = document.createElement('div');
      row.className = 'task';
      row.innerHTML = `
        <div class="tag ${gradeClass(tag)}">${tag}</div>
        <div class="route">
          <div class="main">${safeText(t.pickup)} â†’ ${safeText(t.dropoff)}</div>
          <div class="sub">${safeText(sub)}</div>
        </div>
        <div class="boards">${num(t.boards)} ç‰ˆ</div>
      `;
      body.appendChild(row);
    });
  }

  function renderArea(me){
    const items = (me && me.area && me.area.items) ? me.area.items : [];
    const total = (me && me.area) ? num(me.area.totalBoards) : 0;
    const count = (me && me.area) ? num(me.area.count) : 0;

    el('areaCard').style.display = 'block';
    el('areaStat').textContent = `ï¼ˆç­†æ•¸ ${count}ï½œç¸½ç‰ˆæ•¸ ${total}ï¼‰`;

    const body = el('areaBody');
    body.innerHTML = '';

    if (!items.length){
      el('noArea').style.display = 'block';
      return;
    }
    el('noArea').style.display = 'none';

    // âœ… å€é…ï¼šä¾ seq æ’åºï¼ˆæ²’æœ‰ seq æ”¾æœ€å¾Œï¼›åŒ seq ç‰ˆæ•¸å¤§åœ¨å‰ï¼‰
    const listSorted = items.slice().sort((a,b)=>{
      const sa = (a.seq === null || a.seq === undefined) ? 999999 : Number(a.seq);
      const sb = (b.seq === null || b.seq === undefined) ? 999999 : Number(b.seq);
      if (sa !== sb) return sa - sb;
      return num(b.boards) - num(a.boards);
    });

    listSorted.forEach(t=>{
      const tag = safeText(t.grade).toUpperCase() || 'S';
      const meta = [];
      if (t.owner) meta.push('è²¨ä¸»:' + safeText(t.owner));
      if (t.note) meta.push('å‚™è¨»:' + safeText(t.note));
      const sub = meta.join(' ï½œ ');

      const recv = cleanReceiverLabel(t.receiver) || cleanReceiverLabel(t.dropLabel) || cleanReceiverLabel(t.dropoff) || '(æœªå¡«æ”¶ä»¶äºº)';
      const seqTxt = (t.seq !== null && t.seq !== undefined) ? `é †åº ${t.seq}ï¼š` : '';
      const mainLine = `${seqTxt}${safeText(t.pickup)} â†’ ${recv}`;

      // âœ… pickupAddrï¼šä½  Code.gs å·²å¡ Fï¼ˆåˆ°è²¨å€‰ï¼‰ä½œç‚ºå€é…æè²¨åœ°é»
      const pickupAddr = safeText(t.pickupAddr || '');
      const recvAddr = safeText(t.recvAddr || '');

      const det = document.createElement('details');
      det.className = 'taskAcc';
      det.innerHTML = `
        <summary>
          <div class="tag ${gradeClass(tag)}">${tag}</div>
          <div class="route">
            <div class="main">${mainLine}</div>
            <div class="sub">${safeText(sub)}</div>
          </div>
          <div class="boards">${num(t.boards)} ç‰ˆ</div>
        </summary>
        <div class="accBody">
          <div class="miniRow">
            <div class="miniLeft">
              <div class="miniTitle">ğŸ“ å€é…æè²¨åœ°é»ï¼ˆFï¼‰</div>
              <div class="miniSub">${pickupAddr}</div>
            </div>
          </div>
          <div class="miniRow" style="margin-bottom:0;">
            <div class="miniLeft">
              <div class="miniTitle">ğŸ æ”¶ä»¶äººåœ°å€ï¼ˆIï¼‰</div>
              <div class="miniSub">${recvAddr}</div>
            </div>
          </div>
        </div>
      `;
      body.appendChild(det);
    });
  }

  function renderAll(payload){
    // reset
    el('errCard').style.display = 'none';

    const me = payload && payload.me ? payload.me : null;
    setTitle(me ? me.driverName : '');

    const chosen = payload ? payload.chosenDate : '';
    setSubtitle(chosen ? `åˆ†é ï¼š${chosen}` : '');

    renderDateButtons(payload.options || {}, chosen);

    // show cards
    renderTransfer(me);
    renderArea(me);
  }

  // ============================
  // Load daily via JSONP
  // ============================
  async function loadDaily(dateTab){
    el('transferCard').style.display = 'none';
    el('areaCard').style.display = 'none';
    el('errCard').style.display = 'none';
    hideBind();

    const uid = getUidFromQuery();
    const d = safeText(dateTab || getDateFromQuery()).trim();

    if (!uid){
      showError('ç¼ºå°‘ uidï¼šè«‹ç”¨ LIFF æˆ–å¸¶ ?uid=xxx é–‹å•Ÿ');
      return;
    }

    setSubtitle('è¼‰å…¥ä¸­â€¦');

    try {
      const url = baseUrl() + '?mode=api_jsonp&uid=' + encodeURIComponent(uid) + (d ? '&date=' + encodeURIComponent(d) : '');
      const data = await jsonp(url);

      if (!data || data.ok === false){
        const msg = data && data.message ? data.message : 'è¼‰å…¥å¤±æ•—';
        // è‹¥æ˜¯æœªç¶å®šï¼Œé–‹ bind UI
        if (safeText(msg).includes('å°šæœªç¶å®š') || safeText(msg).includes('enabled')){
          showBind(msg);
          setSubtitle('éœ€è¦å…ˆç¶å®šå¸æ©Ÿ');
          return;
        }
        showError(msg);
        setSubtitle('è¼‰å…¥å¤±æ•—');
        return;
      }

      // ok
      renderAll(data);
    } catch (e){
      showError(e && e.message ? e.message : String(e));
      setSubtitle('è¼‰å…¥å¤±æ•—');
    }
  }

  // ============================
  // Bind flow
  // ============================
  async function bindNow(){
    const uid = getUidFromQuery();
    const name = safeText(el('bindName').value).trim();
    if (!uid){
      showError('ç¼ºå°‘ uidï¼šè«‹ç”¨ LIFF æˆ–å¸¶ ?uid=xxx é–‹å•Ÿ');
      return;
    }
    if (!name){
      el('bindMsg').textContent = 'è«‹è¼¸å…¥å§“å';
      return;
    }

    el('btnBind').disabled = true;
    el('bindMsg').textContent = 'ç¶å®šä¸­â€¦';

    try{
      const url = baseUrl() + '?mode=bind_jsonp&uid=' + encodeURIComponent(uid) + '&driverName=' + encodeURIComponent(name);
      const data = await jsonp(url);

      if (!data || data.ok === false){
        el('btnBind').disabled = false;
        el('bindMsg').textContent = (data && data.message) ? data.message : 'ç¶å®šå¤±æ•—';
        return;
      }

      el('bindMsg').className = 'ok';
      el('bindMsg').textContent = 'âœ… ç¶å®šæˆåŠŸï¼š' + safeText(data.driverName || '');
      el('btnBind').disabled = false;

      // reload daily after bind
      setTimeout(()=>loadDaily(), 400);
    } catch(e){
      el('btnBind').disabled = false;
      el('bindMsg').textContent = e && e.message ? e.message : String(e);
    }
  }

  el('btnBind').addEventListener('click', bindNow);

  // start
  loadDaily();
</script>
</body>
</html>

