<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¸æ©Ÿä»Šæ—¥ä»»å‹™</title>

  <!-- å¯é¸ï¼šå¦‚æœä½ æœ‰å…±ç”¨ Stylesï¼Œä¹Ÿèƒ½æŠ½å‡ºå»ï¼›é€™è£¡æˆ‘ç›´æ¥å…§åµŒä¸€ä»½ã€Œå¸æ©Ÿç‰ˆå°ˆç”¨ã€ -->
  <style>
    :root{
      --bg:#070A14;
      --bg2:#0B1020;
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.62);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 24px rgba(0,0,0,.32);
      --accent: rgba(198, 170, 110, .95);
      --ice: rgba(140, 196, 255, .95);
      --ok: rgba(120, 240, 180, .95);
      --bad: rgba(255, 90, 90, .95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      background:
        radial-gradient(900px 520px at 18% 0%, rgba(76,112,255,.22) 0%, rgba(7,10,20,0) 55%),
        radial-gradient(760px 460px at 88% 12%, rgba(198,170,110,.14) 0%, rgba(7,10,20,0) 58%),
        radial-gradient(700px 520px at 50% 110%, rgba(140,196,255,.10) 0%, rgba(7,10,20,0) 60%),
        linear-gradient(180deg, var(--bg2) 0%, var(--bg) 100%);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .topbar{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
      padding:14px;border:1px solid var(--line);border-radius:18px;
      background:rgba(18,26,51,.65);
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: var(--shadow2);
      position:relative;
    }
    .topbar:before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:19px;
      padding:1px;
      background: linear-gradient(120deg, rgba(198,170,110,.35), rgba(255,255,255,.10), rgba(140,196,255,.28));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.75;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .title{font-size:15px;margin:0;font-weight:900;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .pill{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10) 0%, rgba(255,255,255,.04) 100%);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      color: rgba(234,240,255,.92);
      box-shadow: 0 1px 0 rgba(255,255,255,.12) inset, 0 10px 18px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(120,240,180,.25); background: rgba(120,240,180,.08);}
    .pill.bad{border-color: rgba(255,90,90,.25); background: rgba(255,90,90,.08);}

    select,button,input{
      border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10) 0%, rgba(255,255,255,.04) 100%);
      color:var(--text);
      padding:10px 12px;font-size:14px;
      outline:none;
      box-shadow: 0 1px 0 rgba(255,255,255,.12) inset, 0 10px 18px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    select{padding-right:34px}
    button{cursor:pointer;font-weight:900;letter-spacing:.2px}
    button:hover, select:hover, input:hover{
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 1px 0 rgba(255,255,255,.14) inset, 0 16px 26px rgba(0,0,0,.28);
      transform: translateY(-1px);
    }
    button:active,select:active,input:active{transform: translateY(0px)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .grid{display:flex;flex-direction:column;gap:14px;margin-top:14px}
    .card{
      border:1px solid var(--line);border-radius:18px;
      background:rgba(18,26,51,.65);padding:14px;
      backdrop-filter: blur(12px) saturate(140%);
      box-shadow: var(--shadow);
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:19px;
      padding:1px;
      background: linear-gradient(120deg, rgba(140,196,255,.22), rgba(255,255,255,.08), rgba(198,170,110,.22));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.55;
    }
    .card h2{font-size:14px;margin:0 0 10px;color:#cfe0ff;font-weight:900;letter-spacing:.2px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hint{font-size:12px;color:var(--muted)}

    details{border:1px solid var(--line2);border-radius:14px;background:rgba(255,255,255,.03);overflow:hidden}
    details+details{margin-top:10px}
    summary{
      cursor:pointer;list-style:none;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 12px;
      gap:10px;
    }
    summary::-webkit-details-marker{display:none}
    .accBody{padding:10px;display:flex;flex-direction:column;gap:10px}

    .driverHeader{
      display:flex;flex-direction:column;gap:2px;
    }
    .driverName{font-size:16px;font-weight:900}
    .driverMeta{font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color: rgba(234,240,255,.92);
      white-space:nowrap;
    }

    .routeGroup{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:10px;background:rgba(255,255,255,.03)
    }
    .routeGroupTitle{
      display:flex;justify-content:space-between;gap:10px;
      font-weight:900;margin-bottom:8px
    }
    .routeGroupTitle .t{font-weight:900}
    .routeGroupTitle .n{font-weight:900;color:rgba(234,240,255,.95)}
    .routeGroupList{display:flex;flex-direction:column;gap:8px}

    .task{
      display:grid;grid-template-columns:56px 1fr 70px;
      gap:8px;align-items:center;
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)
    }
    .tag{font-weight:900;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);text-align:center}
    .tag.h{background:rgba(255,90,90,.22);border-color:rgba(255,90,90,.30)}
    .tag.s{background:rgba(140,196,255,.18);border-color:rgba(140,196,255,.26)}
    .tag.n{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.10)}
    .route .main{font-weight:900}
    .route .sub{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.35}
    .boards{font-weight:900;text-align:right}

    .badgeArea{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(198,170,110,.28);
      background: rgba(198,170,110,.10);
      color: rgba(234,240,255,.95);
      font-size:12px;font-weight:900;
      margin-left:8px;
      vertical-align:middle;
      white-space:nowrap;
    }
    .seq{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:34px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(140,196,255,.22);
      background: rgba(140,196,255,.10);
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }

    .empty{font-size:12px;color:var(--muted)}
    .notice{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .notice .t{font-weight:900}
    .notice .d{font-size:12px;color:var(--muted);line-height:1.45;margin-top:2px}

    /* åœ°å€é•·å­—ä¸²çˆ†ç‰ˆä¿éšª */
    .route .main,.route .sub{
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .bindForm{
      display:flex;flex-direction:column;gap:10px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .bindRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .bindRow input{flex:1;min-width:220px}
    .small{font-size:12px;color:var(--muted);line-height:1.5}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:6px 0}
  </style>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <div class="wrap">

    <!-- Top -->
    <div class="topbar">
      <div class="brand">
        <div class="title">å¸æ©Ÿä»Šæ—¥ä»»å‹™</div>
        <div class="sub" id="subtitle">åˆå§‹åŒ–ä¸­â€¦</div>
      </div>
      <div class="spacer"></div>

      <div class="row" style="justify-content:flex-end">
        <div class="pill" id="pillStatus">å°šæœªç™»å…¥</div>
      </div>
    </div>

    <div class="grid">

      <!-- Controls -->
      <div class="card">
        <h2>ğŸ“… æ—¥æœŸ</h2>
        <div class="row">
          <div class="hint">ä»Šå¤©ï¼ˆå°ç£ï¼‰ï¼š</div>
          <div class="pill" id="todayPill">â€”</div>
          <div class="spacer"></div>
          <select id="dateSelect"></select>
          <button id="btnReload">æ›´æ–°ä»»å‹™</button>
        </div>
        <div class="empty" id="controlHint" style="margin-top:10px;display:none;"></div>
      </div>

      <!-- Bind -->
      <div class="card" id="bindCard" style="display:none;">
        <h2>ğŸ”— ç¶å®šå¸æ©Ÿ</h2>
        <div class="notice">
          <div>ğŸ§¾</div>
          <div>
            <div class="t">ä½ çš„ LINE å°šæœªç¶å®šå¸æ©Ÿ</div>
            <div class="d">è«‹è¼¸å…¥å§“åï¼ˆå°ç…§è¡¨å…§çš„å§“åï¼‰ã€‚ç³»çµ±æœƒè‡ªå‹•å¿½ç•¥å°¾å·´æ•¸å­—ï¼ˆä¾‹å¦‚ã€Œé˜¿æ˜1ã€æœƒè¦–ç‚ºã€Œé˜¿æ˜ã€ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="bindForm">
          <div class="bindRow">
            <input id="inpName" placeholder="è¼¸å…¥ä½ çš„å§“åï¼ˆä¾‹å¦‚ï¼šç‹å°æ˜ / é˜¿æ˜ï¼‰" />
            <button id="btnBind">ç«‹å³ç¶å®š</button>
          </div>
          <div class="small" id="bindMsg"> </div>
          <div class="divider"></div>
          <div class="small">å¦‚æœè¼¸å…¥å¾Œä»ç„¡æ³•ç¶å®šï¼Œè«‹è¯çµ¡ç®¡ç†å“¡å”åŠ©è™•ç†ã€ŒåŒåå¤šç­†ã€æˆ–ã€Œå·²è¢«å…¶ä»– LINE ç¶å®šã€ç­‰ç‹€æ³ã€‚</div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="card" id="taskCard" style="display:none;">
        <h2>ğŸšš ä»Šæ—¥é…é€</h2>

        <details open class="driverAcc">
          <summary>
            <div class="driverHeader">
              <div class="driverName" id="driverName">â€”</div>
              <div class="driverMeta" id="driverMeta">â€”</div>
            </div>
            <div class="chips">
              <div class="chip" id="chipCount">ç­†æ•¸ï¼š0</div>
              <div class="chip" id="chipBoards">ç¸½ç‰ˆæ•¸ï¼š0</div>
            </div>
          </summary>
          <div class="accBody" id="taskBody">
            <div class="empty">è¼‰å…¥ä¸­â€¦</div>
          </div>
        </details>

        <div class="empty" id="noTasks" style="display:none;">ä»Šæ—¥æ²’æœ‰ä½ çš„ä»»å‹™</div>
      </div>

      <!-- Error -->
      <div class="card" id="errorCard" style="display:none;">
        <h2>âš ï¸ æç¤º</h2>
        <div class="notice">
          <div>â„¹ï¸</div>
          <div>
            <div class="t" id="errorTitle">ç›®å‰ç„¡æ³•è®€å–ä»»å‹™</div>
            <div class="d" id="errorDetail">â€”</div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  // ====== CONFIG ======
  const LIFF_ID = "2008915809-vp9PFMVX";
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxY-cAz9uSlEo44YA7GAp6DYtAog3VTxLWWSAesQKiok2w2HxkOVOe_UnhNw5nV9K5C/exec";

  // ====== utils ======
  const el = (id) => document.getElementById(id);
  const safeText = (v) => (v === null || v === undefined) ? "" : String(v);
  const num = (v) => Number(v || 0);

  function setStatusPill(text, type){
    const p = el("pillStatus");
    p.textContent = text;
    p.classList.remove("ok","bad");
    if (type) p.classList.add(type);
  }
  function setSubtitle(text){ el("subtitle").textContent = text; }

  // âœ… å¿½ç•¥å°¾å·´æ•¸å­—ï¼ˆé¡¯ç¤ºç”¨ï¼‰
  function stripTrailingDigits(name){
    return safeText(name).trim().replace(/[0-9ï¼-ï¼™]+$/g, "");
  }
  // âœ… å–é †åºå°¾ç¢¼ï¼ˆå€é…ç”¨ï¼‰
  function trailingSeq(name){
    const m = safeText(name).trim().match(/([0-9ï¼-ï¼™]+)$/);
    if (!m) return null;
    const digits = m[1].replace(/[ï¼-ï¼™]/g, d => String("ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™".indexOf(d)));
    const n = Number(digits);
    return Number.isFinite(n) ? n : null;
  }

  function gradeClass(g){
    if (g === "H") return "h";
    if (g === "S") return "s";
    return "n";
  }

  // JSONP
  function jsonp(url, cbParam="callback"){
    return new Promise((resolve, reject)=>{
      const cbName = "__cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + cbParam + "=" + cbName;
      script.async = true;

      const timer = setTimeout(()=>{
        cleanup();
        reject(new Error("é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦"));
      }, 12000);

      function cleanup(){
        clearTimeout(timer);
        delete window[cbName];
        script.remove();
      }

      window[cbName] = (data)=>{
        cleanup();
        resolve(data);
      };

      script.onerror = ()=>{
        cleanup();
        reject(new Error("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–ç¶²å€"));
      };

      document.body.appendChild(script);
    });
  }

  function showBind(show){
    el("bindCard").style.display = show ? "block" : "none";
  }
  function showTasks(show){
    el("taskCard").style.display = show ? "block" : "none";
  }
  function showError(show, title, detail){
    el("errorCard").style.display = show ? "block" : "none";
    if (title) el("errorTitle").textContent = title;
    if (detail) el("errorDetail").textContent = detail;
  }

  function setLoading(on){
    el("btnReload").disabled = on;
    el("btnReload").textContent = on ? "è¼‰å…¥ä¸­â€¦" : "æ›´æ–°ä»»å‹™";
    el("btnBind").disabled = on;
    el("btnBind").textContent = on ? "è™•ç†ä¸­â€¦" : "ç«‹å³ç¶å®š";
  }

  // ====== date select ======
  function buildDateOptions(options){
    const sel = el("dateSelect");
    sel.innerHTML = "";

    const map = [
      ["dMinus2","D-2"],
      ["dMinus1","D-1"],
      ["d","Dï¼ˆé è¨­ï¼‰"],
      ["dPlus1","D+1"],
      ["dPlus2","D+2"]
    ];

    const avail = [];
    map.forEach(([k,label])=>{
      const tab = options ? options[k] : null;
      if (!tab) return;
      avail.push({tab,label});
    });

    avail.forEach(x=>{
      const opt = document.createElement("option");
      opt.value = x.tab;
      opt.textContent = `${x.label}ã€€(${x.tab})`;
      sel.appendChild(opt);
    });

    // é è¨­é¸ Dï¼ˆå¦‚æœæœ‰ï¼‰
    if (options && options.d){
      sel.value = options.d;
    }
  }

  // ====== render (Transfer + Area) ======
  function renderTasks(payload){
    const driverNameRaw = safeText(payload.driverName);
    const driverName = stripTrailingDigits(driverNameRaw);
    const chosenDate = safeText(payload.chosenDate);

    el("driverName").textContent = `ğŸšš ${driverName}`;
    el("driverMeta").textContent = `åˆ†é ï¼š${chosenDate}`;

    const daily = payload.daily || {};
    const block2 = daily.block2 || {};

    const transferDrivers = block2.transferDrivers || [];
    const areaDrivers = block2.areaDrivers || [];

    // å¾å…©å€‹é›†åˆè£¡æ‰¾ã€Œæˆ‘çš„é‚£ä¸€ç­†ã€
    // - è½‰é‹ï¼šdriver = å§“å(è½‰)
    // - å€é…ï¼šdriver = å§“å(å€)ï¼ˆå¯èƒ½å¸¶å°¾å·´æ•¸å­— -> æˆ‘å€‘ç”¨ strip ä¾†æ¯”ï¼‰
    const meTransfer = transferDrivers.find(x => stripTrailingDigits(x.driver) === driverName);
    const meArea = areaDrivers.find(x => stripTrailingDigits(x.driver) === driverName);

    const sections = [];

    // è½‰é‹å€å¡Š
    if (meTransfer && (meTransfer.items || []).length){
      sections.push(renderTransferSection(meTransfer));
    }

    // å€é…å€å¡Š
    if (meArea && (meArea.items || []).length){
      sections.push(renderAreaSection(meArea));
    }

    const allCount =
      (meTransfer ? num(meTransfer.count) : 0) +
      (meArea ? num(meArea.count) : 0);

    const allBoards =
      (meTransfer ? num(meTransfer.totalBoards) : 0) +
      (meArea ? num(meArea.totalBoards) : 0);

    el("chipCount").textContent = `ç­†æ•¸ï¼š${allCount}`;
    el("chipBoards").textContent = `ç¸½ç‰ˆæ•¸ï¼š${allBoards}`;

    const body = el("taskBody");
    body.innerHTML = "";

    if (sections.length === 0){
      el("noTasks").style.display = "block";
      body.innerHTML = `<div class="empty">ä»Šæ—¥æ²’æœ‰ä½ çš„ä»»å‹™</div>`;
      return;
    }

    el("noTasks").style.display = "none";
    sections.forEach(s => body.appendChild(s));
  }

  function renderTransferSection(d){
    const wrap = document.createElement("div");
    wrap.className = "routeGroup";

    wrap.innerHTML = `
      <div class="routeGroupTitle">
        <div class="t">ğŸšš è½‰é‹</div>
        <div class="n">${num(d.totalBoards)} ç‰ˆ</div>
      </div>
      <div class="routeGroupList"></div>
    `;

    const listEl = wrap.querySelector(".routeGroupList");
    // items å·²ç¶“æ˜¯ã€ŒåŒæ->åŒåˆ°åˆä½µå¾Œã€æˆ–æœªåˆä½µéƒ½å¯ï¼Œé€™è£¡ç›´æ¥åƒ
    (d.items || []).forEach(t=>{
      const tag = (safeText(t.grade).toUpperCase() === "H") ? "H" : "S";
      const metaParts = [];
      if (t.carNo) metaParts.push(`è»Šè™Ÿ:${safeText(t.carNo)}`);
      if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
      if (t.note) metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
      const sub = metaParts.join(" ï½œ ");

      const task = document.createElement("div");
      task.className = "task";
      task.innerHTML = `
        <div class="tag ${gradeClass(tag)}">${tag}</div>
        <div class="route">
          <div class="main">${safeText(t.pickup)} â†’ ${safeText(t.dropoff)}</div>
          <div class="sub">${sub || ""}</div>
        </div>
        <div class="boards">${num(t.boards)} ç‰ˆ</div>
      `;
      listEl.appendChild(task);
    });

    return wrap;
  }

  // âœ… å€é…ï¼šä¸»é¡¯ç¤ºã€Œæè²¨é» â†’ æ”¶ä»¶äºº(K)ã€ï¼Œé»é–‹çœ‹åœ°å€(H/I)
  function renderAreaSection(d){
    const wrap = document.createElement("div");
    wrap.className = "routeGroup";

    wrap.innerHTML = `
      <div class="routeGroupTitle">
        <div class="t">ğŸŸ£ å€é… <span class="badgeArea">æ”¶ä»¶äººå„ªå…ˆé¡¯ç¤º</span></div>
        <div class="n">${num(d.totalBoards)} ç‰ˆ</div>
      </div>
      <div class="routeGroupList"></div>
    `;

    const listEl = wrap.querySelector(".routeGroupList");

    const items = (d.items || []).slice().sort((a,b)=>{
      const sa = (a.seq != null) ? Number(a.seq) : 999999;
      const sb = (b.seq != null) ? Number(b.seq) : 999999;
      if (sa !== sb) return sa - sb;
      return num(b.boards) - num(a.boards);
    });

    items.forEach(x=>{
      const tag = (safeText(x.grade).toUpperCase() === "H") ? "H" : "S";
      const recvName = safeText(x.receiverName) || "(æœªå¡«æ”¶ä»¶äºº)";
      const main = `${safeText(x.pickup)} â†’ ${recvName}`;

      const meta = [];
      if (x.carNo) meta.push(`è»Šè™Ÿ:${safeText(x.carNo)}`);
      if (x.owner) meta.push(`è²¨ä¸»:${safeText(x.owner)}`);
      if (x.note)  meta.push(`å‚™è¨»:${safeText(x.note)}`);
      const sub1 = meta.join(" ï½œ ");

      const task = document.createElement("div");
      task.className = "task";
      task.innerHTML = `
        <div class="tag ${gradeClass(tag)}">${tag}</div>
        <div class="route">
          <div class="main">${main}</div>
          <div class="sub">${sub1 || ""}</div>
        </div>
        <div class="boards">${num(x.boards)} ç‰ˆ</div>
      `;

      const addrDet = document.createElement("details");
      addrDet.style.marginTop = "6px";
      addrDet.innerHTML = `
        <summary>
          <div class="driverHeader">
            <div class="driverName"><span class="seq">#${x.seq != null ? x.seq : "-"}</span>ã€€æŸ¥çœ‹åœ°å€</div>
            <div class="driverMeta">é»é–‹çœ‹ï¼šå€é…æè²¨åœ°å€ / æ”¶ä»¶äººåœ°å€</div>
          </div>
          <div></div>
        </summary>
        <div class="accBody">
          <div class="notice">
            <div>ğŸ“</div>
            <div>
              <div class="t">å€é…æè²¨åœ°å€</div>
              <div class="d">${safeText(x.pickupAddr) || "(æœªå¡«)"}</div>
            </div>
          </div>
          <div class="notice">
            <div>ğŸ</div>
            <div>
              <div class="t">æ”¶ä»¶äººåœ°å€</div>
              <div class="d">${safeText(x.receiverAddr) || "(æœªå¡«)"}</div>
            </div>
          </div>
        </div>
      `;

      const wrap2 = document.createElement("div");
      wrap2.appendChild(task);
      wrap2.appendChild(addrDet);
      listEl.appendChild(wrap2);
    });

    return wrap;
  }

  // ====== bind flow ======
  async function bindMe(uid){
    const name = safeText(el("inpName").value).trim();
    if (!name){
      el("bindMsg").textContent = "è«‹å…ˆè¼¸å…¥å§“å";
      el("bindMsg").style.color = "rgba(255,255,255,.85)";
      return;
    }

    setLoading(true);
    el("bindMsg").textContent = "è™•ç†ä¸­â€¦";
    el("bindMsg").style.color = "rgba(234,240,255,.82)";

    try{
      const url = `${GAS_EXEC_URL}?mode=bind_jsonp&uid=${encodeURIComponent(uid)}&driverName=${encodeURIComponent(name)}`;
      const res = await jsonp(url);

      if (!res || res.ok !== true){
        throw new Error(res?.message || "ç¶å®šå¤±æ•—");
      }

      el("bindMsg").textContent = "âœ… ç¶å®šæˆåŠŸï¼Œæ­£åœ¨è¼‰å…¥ä»»å‹™â€¦";
      el("bindMsg").style.color = "rgba(120,240,180,.95)";

      // ç¶å®šå¾Œç›´æ¥æ‹‰ä»»å‹™
      await loadDaily(uid, el("dateSelect").value || "");
    }catch(err){
      el("bindMsg").textContent = "âŒ " + (err?.message || err);
      el("bindMsg").style.color = "rgba(255,90,90,.95)";
      showError(true, "ç¶å®šå¤±æ•—", err?.message || String(err));
    }finally{
      setLoading(false);
    }
  }

  // ====== data load ======
  async function loadDaily(uid, dateTab){
    setLoading(true);
    showError(false);
    showTasks(false);

    try{
      const url = `${GAS_EXEC_URL}?mode=api_jsonp&uid=${encodeURIComponent(uid)}&date=${encodeURIComponent(dateTab || "")}`;
      const data = await jsonp(url);

      if (!data || data.ok !== true){
        // æœªç¶å®š â†’ é¡¯ç¤ºç¶å®š UI
        const msg = safeText(data?.message);
        if (msg.includes("å°šæœªç¶å®šå¸æ©Ÿ")){
          showBind(true);
          showTasks(false);
          showError(false);
          setSubtitle("å°šæœªç¶å®šï¼Œè«‹è¼¸å…¥å§“å");
          return;
        }
        throw new Error(msg || "è®€å–å¤±æ•—");
      }

      // æˆåŠŸ
      showBind(false);
      showTasks(true);
      showError(false);

      // æ—¥æœŸ options
      const opt = data.options || {};
      el("todayPill").textContent = safeText(opt.baseToday || "â€”");
      buildDateOptions(opt);

      // è‹¥å¤–éƒ¨æŒ‡å®š dateTabï¼Œä¿æŒé¸é …
      if (dateTab && safeText(dateTab)){
        el("dateSelect").value = dateTab;
      }

      renderTasks(data);

      setSubtitle(`å·²è¼‰å…¥ï¼š${stripTrailingDigits(data.driverName)}ï¼ˆ${safeText(data.chosenDate)}ï¼‰`);
      setStatusPill("å·²ç™»å…¥", "ok");
    }catch(err){
      showBind(false);
      showTasks(false);
      showError(true, "ç›®å‰ç„¡æ³•è®€å–ä»»å‹™", err?.message || String(err));
      setSubtitle("è¼‰å…¥å¤±æ•—");
      setStatusPill("ç™¼ç”ŸéŒ¯èª¤", "bad");
    }finally{
      setLoading(false);
    }
  }

  // ====== init ======
  async function main(){
    setSubtitle("åˆå§‹åŒ– LIFFâ€¦");

    try{
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()){
        setSubtitle("å°å‘ç™»å…¥â€¦");
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const uid = safeText(profile?.userId || "");

      if (!uid){
        throw new Error("LINE userId å–å¾—å¤±æ•—ï¼ˆè«‹ç¢ºèª LIFF scope æœ‰ profileï¼‰");
      }

      setStatusPill("å·²ç™»å…¥", "ok");
      setSubtitle("è®€å–ä»»å‹™ä¸­â€¦");

      // ç¬¬ä¸€æ¬¡å…ˆæ‹‰ä»»å‹™ï¼ˆä¸æŒ‡å®šæ—¥æœŸï¼Œè®“å¾Œç«¯ç”¨ Dï¼‰
      await loadDaily(uid, "");

      // ç¶å®šæŒ‰éˆ•
      el("btnBind").addEventListener("click", ()=>bindMe(uid));

      // é‡æ–°è¼‰å…¥
      el("btnReload").addEventListener("click", ()=>loadDaily(uid, el("dateSelect").value || ""));
      el("dateSelect").addEventListener("change", ()=>loadDaily(uid, el("dateSelect").value || ""));

    }catch(err){
      showError(true, "åˆå§‹åŒ–å¤±æ•—", err?.message || String(err));
      setSubtitle("åˆå§‹åŒ–å¤±æ•—");
      setStatusPill("å°šæœªç™»å…¥", "bad");
    }
  }

  main();
</script>
</body>
</html>
