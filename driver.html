<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¸æ©Ÿä»»å‹™</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --bd:rgba(255,255,255,.10);
      --bd2:rgba(255,255,255,.14);
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --muted2:#6b7280;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fca5a5;
      --chip:rgba(255,255,255,.10);
      --chipbd:rgba(255,255,255,.14);
      --btnbg:rgba(255,255,255,.10);
      --btnbd:rgba(255,255,255,.16);
      --focus:rgba(255,255,255,.28);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", sans-serif;
      background: radial-gradient(900px 600px at 20% 0%, rgba(59,130,246,.18), transparent 60%),
                  radial-gradient(700px 500px at 80% 10%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 26px;}
    .header{
      display:flex;align-items:flex-start;gap:10px;flex-wrap:wrap;
      padding:14px;border:1px solid var(--bd);background:var(--card);
      border-radius:16px;box-shadow:var(--shadow);margin-bottom:12px;
    }
    .brand{flex:1;min-width:240px}
    .title{font-size:18px;font-weight:900;letter-spacing:.2px;margin:0 0 4px}
    .subtitle{font-size:13px;color:var(--muted);line-height:1.45}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--chip);border:1px solid var(--chipbd);
      padding:6px 10px;border-radius:999px;font-size:13px;color:var(--txt);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--muted2)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    label{font-size:12px;color:var(--muted)}
    select, input{
      background:rgba(255,255,255,.08);
      border:1px solid var(--bd2);
      color:var(--txt);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    select:focus, input:focus{border-color:var(--focus)}
    button{
      background:var(--btnbg);
      border:1px solid var(--btnbd);
      color:var(--txt);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
    }
    button:hover{filter:brightness(1.08)}
    button:disabled{opacity:.6;cursor:not-allowed}

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
      display:flex;align-items:center;gap:8px;
    }
    .muted{color:var(--muted);font-size:13px;line-height:1.45}
    .fine{color:var(--muted2);font-size:12px;line-height:1.45}
    .empty{
      padding:14px;border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;color:var(--muted);background:rgba(0,0,0,.18);
    }

    details{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
      overflow:hidden;
    }
    summary{cursor:pointer;list-style:none;font-weight:900;outline:none}
    summary::-webkit-details-marker{display:none}
    .sumline{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sumtitle{font-size:14px}
    .sumright{font-size:13px;color:var(--muted)}

    .task{
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .task:last-child{border-bottom:0}
    .taskTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .taskMain{font-size:14px;font-weight:900}
    .taskMain .seq{
      display:inline-block;
      min-width:30px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(59,130,246,.18);
      border:1px solid rgba(59,130,246,.28);
      font-size:12px;
      font-weight:900;
      color:#dbeafe;
      margin-right:8px;
      text-align:center;
    }
    .taskBoards{
      font-weight:900;
      font-size:14px;
      white-space:nowrap;
      color:#e8f2ff;
    }
    .taskMeta{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.45}
    code{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 6px;border-radius:8px;
      word-break:break-all;
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:8px
    }
    .tabBtn{
      padding:8px 10px;border-radius:999px;font-size:13px;font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.30);
    }

    .bindBox{
      margin-top:10px;
      padding:12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    .bindRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .hintLine{margin-top:6px}
    .right{margin-left:auto}
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="brand">
      <div class="title">å¸æ©Ÿä»»å‹™</div>
      <div class="subtitle" id="subtitle">åˆå§‹åŒ–ä¸­â€¦</div>

      <div class="tabs" id="viewTabs" style="display:none;">
        <div class="tabBtn active" data-tab="all">å…¨éƒ¨</div>
        <div class="tabBtn" data-tab="transfer">è½‰é‹</div>
        <div class="tabBtn" data-tab="area">å€é…</div>
      </div>
    </div>

    <div class="controls">
      <div class="row" id="topRow" style="display:none;">
        <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">å¾…å‘½</span></div>
        <div class="pill" id="pillDriver" style="display:none;"></div>
        <div class="pill" id="pillToday" style="display:none;"></div>

        <label class="right">æ—¥æœŸ</label>
        <select id="dateSelect"></select>
        <button id="refreshBtn" type="button">é‡æ–°æ•´ç†</button>
      </div>
    </div>

    <details style="width:100%;" id="debugPanel">
      <summary>
        <div class="sumline">
          <div class="sumtitle">Debugï¼ˆç®¡ç†å“¡ç”¨ï¼‰</div>
          <div class="sumright">é»é–‹æŸ¥çœ‹ userId / éŒ¯èª¤ç´°ç¯€</div>
        </div>
      </summary>
      <div class="fine" id="debug"></div>
    </details>
  </div>

  <!-- ç¶å®šå€å¡Šï¼ˆæœªç¶å®šæ™‚æ‰é¡¯ç¤ºï¼‰ -->
  <div class="card" id="bindCard" style="display:none;">
    <h2>ğŸ” ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼šè«‹ç¶å®šå¸æ©Ÿ</h2>
    <div class="muted">
      ç³»çµ±éœ€è¦æŠŠä½ çš„ LINE èº«åˆ†ç¶å®šåˆ°å¸æ©Ÿå§“åï¼Œä¹‹å¾Œå°±æœƒè‡ªå‹•é¡¯ç¤ºä½ çš„ä»»å‹™ã€‚
    </div>

    <div class="bindBox">
      <div class="muted">
        1) è«‹è¼¸å…¥ä½ çš„å¸æ©Ÿå§“åï¼ˆå°ç…§ Excel çš„ã€Œå§“å(è½‰)ã€/ã€Œå§“å(å€)ã€ï¼‰<br/>
        2) åç¨±å¾Œé¢çš„æ•¸å­—ï¼ˆä¾‹å¦‚ <code>5é˜¿æ˜1</code>ï¼‰ç³»çµ±æœƒè‡ªå‹•å¿½ç•¥ï¼Œä¸ç”¨åˆ»æ„è¼¸å…¥
      </div>

      <div class="bindRow">
        <input id="bindName" placeholder="ä¾‹å¦‚ï¼šé˜¿æ˜ / é˜¿æ˜1 / 5é˜¿æ˜1" style="min-width:240px;flex:1;" />
        <button id="bindBtn" type="button">ç«‹å³ç¶å®š</button>
      </div>

      <div class="fine hintLine" id="bindHint"></div>
    </div>
  </div>

  <div class="grid" id="content">
    <div class="card">
      <h2>ğŸ“Œ æç¤º</h2>
      <div class="muted">
        è«‹ç¨å€™â€¦æ­£åœ¨è®€å–ä½ çš„ä»»å‹™ã€‚
      </div>
    </div>
  </div>

  <div class="card">
    <div class="muted">
      è‹¥é‡åˆ°å•é¡Œï¼Œè«‹æŠŠ Debug è£¡çš„ <code>lineUserId</code> æä¾›çµ¦ç®¡ç†å“¡ã€‚
    </div>
  </div>
</div>

<script>
  // ===== åªè¦ç¢ºèªé€™å…©è¡Œæ˜¯ä½ çš„ =====
  const LIFF_ID = "2008915809-vp9PFMVX";
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxY-cAz9uSlEo44YA7GAp6DYtAog3VTxLWWSAesQKiok2w2HxkOVOe_UnhNw5nV9K5C/exec";

  let currentUserId = null;
  let currentTabView = "all"; // all | transfer | area

  const $ = (id)=>document.getElementById(id);

  function setDot(type){
    const dot = $("statusDot");
    dot.className = "dot" + (type ? " " + type : "");
  }
  function setStatus(text, type){
    $("statusText").textContent = text || "";
    setDot(type || "");
    $("subtitle").textContent = text || "";
  }

  function setDebug(html){ $("debug").innerHTML = html || ""; }

  // ===== åç¨±è™•ç†ï¼šå¿½è¦–æ•¸å­—ï¼ˆå«å…¨å½¢ï¼‰ï¼Œç”¨æ–¼æ¯”å°èˆ‡é¡¯ç¤º =====
  function normalizeDriverName(name){
    return String(name || "")
      .trim()
      .replace(/\s+/g,"")
      .replace(/[0-9ï¼-ï¼™]/g,"")
      .toLowerCase();
  }
  function prettyDriverName(name){
    return String(name || "")
      .trim()
      .replace(/[0-9ï¼-ï¼™]/g,"")
      .replace(/\s+/g," ")
      .trim();
  }

  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  // ===== JSONPï¼ˆè§£ CORSï¼‰=====
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cbName] = (data) => { cleanup(); resolve(data); };

      function cleanup(){
        try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      script.onerror = () => { cleanup(); reject(new Error("JSONP è¼‰å…¥å¤±æ•—ï¼ˆGAS /exec ç„¡å›æ‡‰æˆ–è¢«é˜»æ“‹ï¼‰")); };

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + encodeURIComponent(cbName);
      document.head.appendChild(script);
    });
  }

  function callApiJsonp({ uid, date }) {
    const params = new URLSearchParams({
      mode: "api_jsonp",
      uid: uid || "",
      date: date || ""
    });
    return jsonp(GAS_EXEC_URL + "?" + params.toString());
  }

  function callBindJsonp({ uid, driverName }) {
    const params = new URLSearchParams({
      mode: "bind_jsonp",
      uid: uid || "",
      driverName: driverName || ""
    });
    return jsonp(GAS_EXEC_URL + "?" + params.toString());
  }

  // ===== æ—¥æœŸé¸å–®ï¼ˆäº”å¤©ï¼‰=====
  function fillDateSelect(options, chosen){
    const sel = $("dateSelect");
    sel.innerHTML = "";

    // åªé¡¯ç¤ºå­˜åœ¨çš„
    const items = [];
    if (options?.dMinus2) items.push({ label: `D-2ï¼ˆ${options.dMinus2}ï¼‰`, value: options.dMinus2 });
    if (options?.dMinus1) items.push({ label: `D-1ï¼ˆ${options.dMinus1}ï¼‰`, value: options.dMinus1 });
    if (options?.d)       items.push({ label: `Dï¼ˆ${options.d}ï¼‰`, value: options.d });
    if (options?.dPlus1)  items.push({ label: `D+1ï¼ˆ${options.dPlus1}ï¼‰`, value: options.dPlus1 });
    if (options?.dPlus2)  items.push({ label: `D+2ï¼ˆ${options.dPlus2}ï¼‰`, value: options.dPlus2 });

    for (const it of items){
      const opt = document.createElement("option");
      opt.value = it.value;
      opt.textContent = it.label;
      if (it.value === chosen) opt.selected = true;
      sel.appendChild(opt);
    }

    sel.onchange = () => fetchDaily(sel.value);
  }

  function showTopbar(driverName, chosenDate, baseToday){
    $("topRow").style.display = "flex";

    const pretty = prettyDriverName(driverName);
    $("pillDriver").style.display = "inline-flex";
    $("pillDriver").innerHTML = `ğŸ‘¤ å¸æ©Ÿï¼š<b>${esc(pretty)}</b>`;

    $("pillToday").style.display = "inline-flex";
    $("pillToday").innerHTML = `ğŸ“… ä»Šå¤©ï¼š<b>${esc(baseToday || chosenDate)}</b>`;
  }

  // ===== Tabsï¼ˆå…¨éƒ¨/è½‰é‹/å€é…ï¼‰=====
  function setupTabs(){
    const tabs = $("viewTabs");
    tabs.style.display = "flex";

    tabs.querySelectorAll(".tabBtn").forEach(btn=>{
      btn.onclick = ()=>{
        tabs.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        currentTabView = btn.dataset.tab || "all";
        // é‡æ–°æ¸²æŸ“ï¼šç”¨æœ€å¾Œä¸€æ¬¡çš„è³‡æ–™
        if (window.__lastRender) window.__lastRender();
      };
    });
  }

  // ===== æ¸²æŸ“ï¼šè½‰é‹ =====
  function renderTransferSection(driverName, daily){
    const transferDrivers = daily?.block2?.transferDrivers || [];
    const target = normalizeDriverName(driverName);

    // æ‰¾åˆ°æ­¤å¸æ©Ÿï¼ˆå¿½ç•¥æ•¸å­—ï¼‰
    const d = transferDrivers.find(x => normalizeDriverName(x.driver) === target);
    const items = d?.items || [];

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>ğŸšš è½‰é‹ä»»å‹™</h2>`;

    if (!items.length){
      const div = document.createElement("div");
      div.className = "empty";
      div.textContent = "ä»Šå¤©æ²’æœ‰è½‰é‹ä»»å‹™ã€‚";
      card.appendChild(div);
      return card;
    }

    // ä¾æè²¨é»åˆ†çµ„ï¼ˆæ²¿ç”¨ pickup/dropoffï¼‰
    const byPickup = new Map();
    for (const it of items){
      const k = (it.pickup || "").trim() || "(æœªå¡«æè²¨)";
      if (!byPickup.has(k)) byPickup.set(k, []);
      byPickup.get(k).push(it);
    }

    for (const [pickup, arr] of byPickup.entries()){
      const det = document.createElement("details");
      det.open = true;

      const totalBoards = arr.reduce((s,x)=>s + Number(x.boards||0), 0);
      det.innerHTML = `
        <summary>
          <div class="sumline">
            <div class="sumtitle">${esc(pickup)}</div>
            <div class="sumright">${esc(arr.length)} ç­†ï½œå…± ${esc(totalBoards)} ç‰ˆ</div>
          </div>
        </summary>
      `;

      arr.forEach(it=>{
        const task = document.createElement("div");
        task.className = "task";

        const meta = [];
        if (it.grade) meta.push(`ç­‰ç´šï¼š${esc(it.grade)}`);
        if (it.owner) meta.push(`è²¨ä¸»ï¼š${esc(it.owner)}`);
        if (it.carNo) meta.push(`è»Šè™Ÿï¼š${esc(it.carNo)}`);
        const meta2 = [];
        if (it.note) meta2.push(`å‚™è¨»ï¼š${esc(it.note)}`);

        task.innerHTML = `
          <div class="taskTop">
            <div class="taskMain">${esc(it.pickup || "")} â†’ ${esc(it.dropoff || "")}</div>
            <div class="taskBoards">${esc(it.boards ?? "")} ç‰ˆ</div>
          </div>
          <div class="taskMeta">${meta.join(" ï½œ ")}</div>
          ${meta2.length ? `<div class="taskMeta">${meta2.join(" ï½œ ")}</div>` : ""}
        `;
        det.appendChild(task);
      });

      card.appendChild(det);
    }

    return card;
  }

  // ===== æ¸²æŸ“ï¼šå€é… =====
  function renderAreaSection(driverName, daily){
    const areaDrivers = daily?.block2?.areaDrivers || [];
    const target = normalizeDriverName(driverName);

    // areaDrivers.driver å¾Œç«¯å·²æ˜¯ä¹¾æ·¨åï¼ˆæˆ‘åœ¨ GAS ç”¨ parseNameWithSeq_ æ‹¿æ‰å°¾ç¢¼æ•¸å­—ï¼‰
    const d = areaDrivers.find(x => normalizeDriverName(x.driver) === target);
    const items = d?.items || [];

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>ğŸŸ£ å€é…ä»»å‹™</h2>`;

    if (!items.length){
      const div = document.createElement("div");
      div.className = "empty";
      div.textContent = "ä»Šå¤©æ²’æœ‰å€é…ä»»å‹™ã€‚";
      card.appendChild(div);
      return card;
    }

    const det = document.createElement("details");
    det.open = true;

    const totalBoards = items.reduce((s,x)=>s + Number(x.boards||0), 0);
    det.innerHTML = `
      <summary>
        <div class="sumline">
          <div class="sumtitle">ä»Šæ—¥å€é…æ¸…å–®</div>
          <div class="sumright">${esc(items.length)} ç­†ï½œå…± ${esc(totalBoards)} ç‰ˆ</div>
        </div>
      </summary>
    `;

    items.forEach((it, idx)=>{
      const task = document.createElement("div");
      task.className = "task";

      // seq ç”±å¾Œç«¯æ’åºï¼Œå‰ç«¯é¡¯ç¤ºï¼šè‹¥æ²’æœ‰ seq ç”¨ idx+1
      const seq = (it.seq !== null && it.seq !== undefined && isFinite(Number(it.seq)))
        ? Number(it.seq)
        : (idx + 1);

      const meta = [];
      if (it.grade) meta.push(`ç­‰ç´šï¼š${esc(it.grade)}`);
      if (it.owner) meta.push(`è²¨ä¸»ï¼š${esc(it.owner)}`);
      if (it.carNo) meta.push(`è»Šè™Ÿï¼š${esc(it.carNo)}`);
      if (it.receiver) meta.push(`æ”¶ä»¶äººï¼š${esc(it.receiver)}`);

      const meta2 = [];
      if (it.note) meta2.push(`å‚™è¨»ï¼š${esc(it.note)}`);
      if (it.orderNo) meta2.push(`è¨‚å–®ï¼š${esc(it.orderNo)}`);

      task.innerHTML = `
        <div class="taskTop">
          <div class="taskMain"><span class="seq">é †åº ${esc(seq)}</span>${esc(it.pickup || "")} â†’ ${esc(it.dropoff || "")}</div>
          <div class="taskBoards">${esc(it.boards ?? "")} ç‰ˆ</div>
        </div>
        <div class="taskMeta">${meta.join(" ï½œ ")}</div>
        ${meta2.length ? `<div class="taskMeta">${meta2.join(" ï½œ ")}</div>` : ""}
      `;
      det.appendChild(task);
    });

    card.appendChild(det);
    return card;
  }

  function renderDailyAll(driverName, chosenDate, baseToday, daily){
    const root = $("content");
    root.innerHTML = "";

    const pretty = prettyDriverName(driverName);

    // é¡¯ç¤ºï¼šé ‚éƒ¨è³‡è¨Š
    showTopbar(pretty, chosenDate, baseToday);

    const hasTransfer = !!(daily?.block2?.transferDrivers || []).find(x => normalizeDriverName(x.driver) === normalizeDriverName(driverName));
    const hasArea = !!(daily?.block2?.areaDrivers || []).find(x => normalizeDriverName(x.driver) === normalizeDriverName(driverName));

    // Tabs é–‹å•Ÿ
    setupTabs();

    // ä¾ tab é¡¯ç¤º
    const sections = [];
    if (currentTabView === "all" || currentTabView === "transfer") {
      sections.push(renderTransferSection(driverName, daily));
    }
    if (currentTabView === "all" || currentTabView === "area") {
      sections.push(renderAreaSection(driverName, daily));
    }

    // å¦‚æœå…©å€‹éƒ½æ²’ä»»å‹™ï¼Œçµ¦ç¸½æç¤º
    if (!hasTransfer && !hasArea) {
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `
        <h2>ğŸ“­ ä»Šæ—¥æ²’æœ‰ä»»å‹™</h2>
        <div class="muted">
          å¯èƒ½åŸå› ï¼š<br/>
          1) ä»Šå¤©æ²’æœ‰æ´¾åˆ°ä»»å‹™<br/>
          2) å¸æ©Ÿå§“åä¸ä¸€è‡´ï¼ˆç³»çµ±æœƒå¿½ç•¥æ•¸å­—ï¼Œä½†ä¸­æ–‡å­—éœ€ä¸€è‡´ï¼‰<br/>
          3) ç®¡ç†å“¡å°šæœªåœ¨ä»Šæ—¥åˆ†é å¡«å…¥ä½ çš„è³‡æ–™
        </div>
      `;
      root.appendChild(c);
      return;
    }

    sections.forEach(s => root.appendChild(s));
  }

  // ===== ç¶å®š UI =====
  function showBindUI(show, hintHtml){
    $("bindCard").style.display = show ? "block" : "none";
    $("bindHint").innerHTML = hintHtml || "";
  }

  async function doBind(){
    const name = ($("bindName").value || "").trim();
    if (!name) {
      $("bindHint").innerHTML = `<span style="color:var(--warn)">è«‹è¼¸å…¥å§“å</span>`;
      return;
    }

    $("bindBtn").disabled = true;
    $("bindBtn").textContent = "ç¶å®šä¸­â€¦";
    $("bindHint").innerHTML = `æ­£åœ¨ç¶å®šï¼Œè«‹ç¨å€™â€¦`;

    try{
      const res = await callBindJsonp({ uid: currentUserId, driverName: name });
      if (!res || res.ok === false) {
        const msg = res?.message || "ç¶å®šå¤±æ•—";
        $("bindHint").innerHTML = `<span style="color:var(--bad)">ç¶å®šå¤±æ•—ï¼š</span>${esc(msg)}`;
      } else {
        $("bindHint").innerHTML = `<span style="color:var(--good)">âœ… ç¶å®šæˆåŠŸ</span>ï¼Œå³å°‡è¼‰å…¥ä»»å‹™â€¦`;
        // ç¶å®šå®Œç›´æ¥é‡æŠ“ä»»å‹™
        await fetchDaily($("dateSelect").value || "");
      }
    } catch(e){
      $("bindHint").innerHTML = `<span style="color:var(--bad)">ç¶å®šå¤±æ•—ï¼š</span>${esc(e?.message || e)}`;
    } finally {
      $("bindBtn").disabled = false;
      $("bindBtn").textContent = "ç«‹å³ç¶å®š";
    }
  }

  // ===== è®€ä»»å‹™ =====
  async function fetchDaily(dateTab){
    setStatus("è®€å–ä»»å‹™ä¸­â€¦", "warn");

    try{
      const res = await callApiJsonp({ uid: currentUserId, date: dateTab });

      // Debug æ°¸é é¡¯ç¤º userId
      setDebug(
        `lineUserIdï¼š<code>${esc(currentUserId || "(æœªå–å¾—)")}</code><br/>` +
        `ç¶²å€ï¼š<code>${esc(location.href)}</code><br/>` +
        `GASï¼š<code>${esc(GAS_EXEC_URL)}</code>`
      );

      if (!res || res.ok === false) {
        const msg = res?.message || "ç›®å‰ç„¡æ³•è®€å–ä»»å‹™";
        // è‹¥æ˜¯æœªç¶å®šï¼Œé¡¯ç¤ºç¶å®š UI
        const isNotBound = /å°šæœªç¶å®š|è«‹åœ¨ç•«é¢å…§è¼¸å…¥å§“åå®Œæˆç¶å®š|enabled/i.test(msg);
        if (isNotBound) {
          setStatus("å°šæœªç¶å®šï¼Œè«‹è¼¸å…¥å§“åå®Œæˆç¶å®š", "warn");
          showBindUI(true, `ä½ çš„ LINE èº«åˆ†å·²å–å¾—ï¼Œå¯ç›´æ¥ç¶å®šã€‚`);
        } else {
          setStatus("ç›®å‰ç„¡æ³•è®€å–ä»»å‹™ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†å“¡", "bad");
          showBindUI(false, "");
        }

        // å…§å®¹å€é¡¯ç¤ºç°¡æ½”è¨Šæ¯
        $("content").innerHTML = `
          <div class="card">
            <h2>ğŸ“Œ ç‹€æ…‹</h2>
            <div class="muted">${esc(msg)}</div>
          </div>
        `;
        return;
      }

      // OKï¼šéš±è—ç¶å®š UI
      showBindUI(false, "");
      setStatus("å·²æ›´æ–°", "good");

      fillDateSelect(res.options, res.chosenDate);

      // è®“é‡æ–°æ¸²æŸ“å¯ç”¨
      window.__lastRender = () => renderDailyAll(res.driverName, res.chosenDate, res.options?.baseToday, res.daily);
      window.__lastRender();

    } catch(e){
      setStatus("ç›®å‰ç„¡æ³•è®€å–ä»»å‹™ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†å“¡", "bad");
      $("content").innerHTML = `
        <div class="card">
          <h2>ğŸ“Œ ç‹€æ…‹</h2>
          <div class="muted">è®€å–å¤±æ•—ï¼š${esc(e?.message || e)}</div>
        </div>
      `;
    }
  }

  // ===== main =====
  async function main(){
    try{
      if (typeof liff === "undefined") {
        setStatus("LIFF SDK æœªè¼‰å…¥ï¼ˆè«‹ç”¨ LINE é–‹å•Ÿæˆ–æª¢æŸ¥ç¶²è·¯ï¼‰", "bad");
        setDebug(`éŒ¯èª¤ï¼š<code>LIFF SDK undefined</code>`);
        return;
      }

      setStatus("LIFF åˆå§‹åŒ–ä¸­â€¦", "warn");
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()){
        setStatus("éœ€è¦ç™»å…¥ï¼Œè·³è½‰ä¸­â€¦", "warn");
        liff.login({ redirectUri: location.href });
        return;
      }

      setStatus("å–å¾— LINE èº«åˆ†ä¸­â€¦", "warn");
      const profile = await liff.getProfile();
      currentUserId = profile.userId;

      $("topRow").style.display = "flex";
      $("refreshBtn").onclick = () => fetchDaily($("dateSelect").value || "");
      $("bindBtn").onclick = doBind;

      // å…ˆæŠ“ä¸€æ¬¡ï¼ˆdate ç©ºå­—ä¸² = ç”¨å¾Œç«¯ Dï¼‰
      await fetchDaily("");

    } catch(e){
      setStatus("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†å“¡", "bad");
      const ua = (navigator.userAgent || "").replace(/</g,"&lt;");
      setDebug(`éŒ¯èª¤ï¼š<code>${esc(e?.message || e)}</code><br/>UAï¼š<code>${ua}</code>`);
    }
  }

  main();
</script>
</body>
</html>
