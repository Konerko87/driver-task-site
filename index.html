<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>

  <!-- âœ… åªåŠ ã€Œå¿…è¦ä¸”å®‰å…¨ã€çš„è£œå¼·æ¨£å¼ï¼šä¸å½±éŸ¿ä½ åŸæœ¬çš„ UI -->
  <style>
    .badgeArea{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(198,170,110,.28);
      background: rgba(198,170,110,.10);
      color: rgba(234,240,255,.95);
      font-size:12px;font-weight:900;
      margin-left:8px;
      vertical-align:middle;
    }
    .seq{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:34px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(140,196,255,.22);
      background: rgba(140,196,255,.10);
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }
    /* åœ°å€/é•·å­—ä¸²çˆ†ç‰ˆä¿éšª */
    .route .main, .route .sub, .miniTitle, .palletText{
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    /* å€é… taskï¼šä»ç”¨åŸæœ¬ task æ ¼å¼ï¼Œåªæ˜¯å…§å®¹ä¸åŒ */
    .task.area{
      grid-template-columns:56px 1fr 70px; /* æ²¿ç”¨ */
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>æ¯æ—¥è»Šè¶Ÿå…¬å‘Šæ¿</h1>
        <div class="sub" id="subtitle">è¼‰å…¥ä¸­â€¦</div>
      </div>
      <div class="spacer"></div>

      <label class="hint">é¸æ“‡æ—¥æœŸåˆ†é </label>
      <select id="dateSelect"></select>
      <button id="btnLoad">ç”¢ç”Ÿ</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ“£ ä»Šæ—¥å…¬å‘Šï¼ˆè½‰é‹ + å€é…ï¼‰</h2>

        <div class="topSplit">
          <!-- LEFT -->
          <div class="box">
            <div class="boxTitle"><span class="ico">ğŸ“Œ</span>é‡æ„Ÿï¼ˆé»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆï¼‰</div>
            <div class="kpiStack" id="kpiStack"></div>
            <div class="empty" id="noKpi" style="display:none;">æ²’æœ‰ KPI è³‡æ–™</div>
          </div>

          <!-- RIGHT -->
          <div class="box">
            <div class="boxTitle"><span class="ico">ğŸšš</span>è½‰é‹æé…è³‡è¨Š</div>
            <div id="announce"></div>
            <div class="empty" id="noAnnounce" style="display:none;">æ²’æœ‰å…¬å‘Šè³‡æ–™</div>
          </div>
        </div>
      </div>

      <!-- Transfer Drivers -->
      <div class="card">
        <h2>ğŸšš è½‰é‹å¸æ©Ÿï¼ˆæ”¶åˆçœ‹æè²¨>å€åŸŸï¼Œé»é–‹çœ‹æ¯æ¢ Eâ†’Fï¼‰</h2>
        <div class="driverGrid" id="transferDrivers"></div>
        <div class="empty" id="noTransferDrivers" style="display:none;">å°šæœªå¡«è½‰é‹å¸æ©Ÿå§“åæˆ–ä»Šæ—¥ç„¡è½‰é‹å¸æ©Ÿè³‡æ–™</div>
      </div>

      <!-- Area Drivers -->
      <div class="card">
        <h2>ğŸŸ£ å€é…å¸æ©Ÿï¼ˆä¾é †åºï¼›é è¦½é¡¯ç¤ºã€Œæè²¨é» â†’ æ”¶ä»¶äººã€ï¼Œé»é–‹çœ‹åœ°å€ï¼‰</h2>
        <div class="driverGrid" id="areaDrivers"></div>
        <div class="empty" id="noAreaDrivers" style="display:none;">å°šæœªå¡«å€é…å¸æ©Ÿå§“åæˆ–ä»Šæ—¥ç„¡å€é…è³‡æ–™</div>
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const safeText = (v) => (v === null || v === undefined) ? '' : String(v);
  const num = (v) => Number(v || 0);

  function setLoading(on) {
    el('btnLoad').disabled = on;
    el('btnLoad').textContent = on ? 'è¼‰å…¥ä¸­â€¦' : 'ç”¢ç”Ÿ';
  }

  function gradeClass(g){
    if (g === 'H') return 'h';
    if (g === 'S') return 's';
    return 'n';
  }

  // ===== name helpers =====
  // âœ… å¿½ç•¥å§“åå°¾å·´æ•¸å­—ï¼ˆä¾‹å¦‚ã€Œé˜¿æ˜1ã€é¡¯ç¤ºæˆã€Œé˜¿æ˜ã€ï¼‰
  function stripTrailingDigits(name){
    return safeText(name).trim().replace(/[0-9ï¼-ï¼™]+$/g, '');
  }
  // âœ… æŠ“å°¾å·´é †åºï¼ˆé˜¿æ˜12 => 12ï¼‰ï¼Œæ²’æœ‰å°± null
  function trailingSeq(name){
    const m = safeText(name).trim().match(/([0-9ï¼-ï¼™]+)$/);
    if (!m) return null;
    const n = Number(m[1].replace(/[ï¼-ï¼™]/g, d => String('ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™'.indexOf(d))));
    return Number.isFinite(n) ? n : null;
  }

  // region helpers
  function regionOf(s){
    const v = safeText(s).trim();
    if (!v) return 'ä¸æ˜';
    if (v.includes('åŒ—')) return 'åŒ—';
    if (v.includes('å—')) return 'å—';
    if (v.includes('ä¸­')) return 'ä¸­';
    return 'ä¸æ˜';
  }

  function uniq(arr){
    const out = [];
    const seen = new Set();
    (arr || []).forEach(x=>{
      const k = safeText(x).trim();
      if (!k) return;
      if (seen.has(k)) return;
      seen.add(k);
      out.push(k);
    });
    return out;
  }

  function formatDropBreakdown(drops){
    return (drops || [])
      .filter(x => safeText(x.dropoff).trim())
      .map(x => `${safeText(x.dropoff)} ${num(x.boards)}ç‰ˆ`)
      .join(' / ');
  }

  // ===== RIGHT =====
  function renderAnnounce(container, pivotArr) {
    container.innerHTML = '';
    if (!pivotArr || pivotArr.length === 0) return;

    pivotArr.forEach(group => {
      const det = document.createElement('details');
      det.className = 'acc';

      const pickup = safeText(group.pickup);

      const toRegionsAll = uniq((group.items || []).map(x => regionOf(x.dropoff)));
      const toRegions = toRegionsAll.filter(r => r !== 'ä¸æ˜');
      const toLine = toRegions.length ? toRegions.join(' / ') : 'ä¸æ˜';

      const dropCount = (group.items || []).length;

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="sumLeft">
          <div class="sumTitle">${pickup}  &nbsp;>&nbsp;  ${toLine}</div>
          <div class="sumSub">é€è²¨é»ï¼š${dropCount} å€‹ï¼ˆé»é–‹çœ‹æ˜ç´°/è²¨ä¸»ï¼‰</div>
        </div>
        <div class="sumRight">${num(group.subtotal)} ç‰ˆ</div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'accBody';

      (group.items || []).forEach(x => {
        const r = document.createElement('div');
        r.className = 'palletRow';
        r.innerHTML = `
          <div class="palletLeft">
            <span class="palletIcon">ğŸ§±</span>
            <div class="palletText">${safeText(x.dropoff)}</div>
          </div>
          <div class="palletNum">${num(x.boards)} ç‰ˆ</div>
        `;
        body.appendChild(r);
      });

      const div = document.createElement('div');
      div.className = 'divider';
      body.appendChild(div);

      if (group.ownerDropItems && group.ownerDropItems.length){
        (group.ownerDropItems || []).forEach(x => {
          const r = document.createElement('div');
          r.className = 'miniRow';
          r.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ§± ${safeText(x.owner)}ã€€æŠµé”å€‰åº«ï¼š${formatDropBreakdown(x.drops)}</div>
            </div>
            <div class="miniNum">å…± ${num(x.totalBoards)} ç‰ˆ</div>
          `;
          body.appendChild(r);
        });
      } else {
        (group.ownerItems || []).forEach(x => {
          const r = document.createElement('div');
          r.className = 'miniRow';
          r.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ§± ${safeText(x.owner)}</div>
            </div>
            <div class="miniNum">${num(x.boards)} ç‰ˆ</div>
          `;
          body.appendChild(r);
        });
      }

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== LEFT: KPI =====
  function buildOwnerByDir(pivotArr){
    const dirs = { north:new Map(), south:new Map(), local:new Map(), unknown:new Map() };

    (pivotArr || []).forEach(g => {
      const from = regionOf(g.pickup);
      const toRegions = uniq((g.items || []).map(x => regionOf(x.dropoff)));

      let bucket = 'unknown';
      if (from === 'åŒ—' && (toRegions.includes('å—') || toRegions.includes('ä¸­'))) bucket = 'south';
      else if (from === 'å—' && (toRegions.includes('åŒ—') || toRegions.includes('ä¸­'))) bucket = 'north';
      else if (from !== 'ä¸æ˜' && toRegions.length === 1 && toRegions[0] === from) bucket = 'local';
      else bucket = 'unknown';

      (g.ownerItems || []).forEach(o => {
        const name = safeText(o.owner) || '(æœªå¡«è²¨ä¸»)';
        dirs[bucket].set(name, (dirs[bucket].get(name) || 0) + num(o.boards));
      });
    });

    const toArr = (m) => Array.from(m.entries())
      .map(([owner, boards])=>({owner, boards}))
      .sort((a,b)=>b.boards-a.boards);

    return {
      north: toArr(dirs.north),
      south: toArr(dirs.south),
      local: toArr(dirs.local),
      unknown: toArr(dirs.unknown),
    };
  }

  function makeKpiAcc(label, value, hint, ownerList){
    const det = document.createElement('details');
    det.className = 'kpiAcc';

    const sum = document.createElement('summary');
    sum.innerHTML = `
      <div class="kpiLeft">
        <div class="kpiLabel">${safeText(label)}</div>
        <div class="kpiHint">${safeText(hint || 'é»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆ')}</div>
      </div>
      <div class="kpiVal">${num(value)}</div>
    `;
    det.appendChild(sum);

    if (ownerList && ownerList.length){
      const body = document.createElement('div');
      body.className = 'accBody';
      ownerList.slice(0, 20).forEach(x => {
        const r = document.createElement('div');
        r.className = 'miniRow';
        r.innerHTML = `
          <div class="miniLeft">
            <div class="miniTitle">${safeText(x.owner)}</div>
          </div>
          <div class="miniNum">${num(x.boards)} ç‰ˆ</div>
        `;
        body.appendChild(r);
      });
      det.appendChild(body);
    }
    return det;
  }

  function renderKpis(container, totals, ownerByDir){
    container.innerHTML = '';
    container.appendChild(makeKpiAcc('ğŸ“¦ å…¬å‘Šç¸½é‡ï¼ˆç‰ˆï¼‰', totals.totalBoards, `åŒ—ä¸Š:${num(totals.north)}ï½œå—ä¸‹:${num(totals.south)}ï½œå€é…:${num(totals.localTotal)}`, []));
    container.appendChild(makeKpiAcc('â¬† åŒ—ä¸Šï¼ˆç‰ˆï¼‰', totals.north, 'é»é–‹çœ‹ï¼šåŒ—ä¸Šè²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.north));
    container.appendChild(makeKpiAcc('â¬‡ å—ä¸‹ï¼ˆç‰ˆï¼‰', totals.south, 'é»é–‹çœ‹ï¼šå—ä¸‹è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.south));
    container.appendChild(makeKpiAcc('ğŸŸ£ å€åŸŸé…é€ï¼ˆç‰ˆï¼‰', totals.area, 'é»é–‹çœ‹ï¼šå€åŸŸé…é€è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.local));
    container.appendChild(makeKpiAcc('âšª ç„¡æ³•åˆ¤æ–·ï¼ˆç‰ˆï¼‰', totals.unknown, 'é»é–‹çœ‹ï¼šä¸æ˜è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.unknown));
    container.appendChild(makeKpiAcc('ğŸš› è½‰é‹ç¸½é‡ï¼ˆç‰ˆï¼‰', totals.transferTotal, 'ï¼ˆç¸½é‡è³‡è¨Šï¼‰', []));
    container.appendChild(makeKpiAcc('ğŸ§© å€é…ç¸½é‡ï¼ˆç‰ˆï¼‰', totals.localTotal, 'ï¼ˆç¸½é‡è³‡è¨Šï¼‰', []));
  }

  // ===== Transfer Drivers helpers =====
  function groupDriverItemsByPickup(items){
    const m = new Map();
    (items || []).forEach(t => {
      const k = safeText(t.pickup);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });

    return Array.from(m.entries()).map(([pickup, list]) => {
      const toRegionsAll = uniq(list.map(x => regionOf(x.dropoff)));
      const toRegions = toRegionsAll.filter(r => r !== 'ä¸æ˜');
      const toLine = toRegions.length ? toRegions.join(' / ') : 'ä¸æ˜';
      return {
        pickup,
        toLine,
        subtotal: list.reduce((s,x)=>s+num(x.boards),0),
        list
      };
    }).sort((a,b)=>b.subtotal-a.subtotal);
  }

  function mergeSameRoute(list){
    const map = new Map();
    (list || []).forEach(t => {
      const pickup = safeText(t.pickup);
      const dropoff = safeText(t.dropoff);
      const key = pickup + 'â†’' + dropoff;

      if (!map.has(key)) {
        map.set(key, {
          pickup,
          dropoff,
          boards: 0,
          grade: 'S',
          carNos: new Set(),
          owners: new Set(),
          notes: new Set()
        });
      }
      const g = map.get(key);

      g.boards += num(t.boards);

      const tg = (safeText(t.grade).toUpperCase() || 'S');
      if (tg === 'H') g.grade = 'H';

      const carNo = safeText(t.carNo).trim();
      if (carNo) g.carNos.add(carNo);

      const owner = safeText(t.owner).trim();
      if (owner) g.owners.add(owner);

      const note = safeText(t.note).trim();
      if (note) g.notes.add(note);
    });

    const out = Array.from(map.values()).map(x => ({
      pickup: x.pickup,
      dropoff: x.dropoff,
      boards: x.boards,
      grade: x.grade,
      carNo: Array.from(x.carNos).join('ã€'),
      owner: Array.from(x.owners).join('ã€'),
      note: Array.from(x.notes).join('ï½œ')
    }));

    out.sort((a,b)=> num(b.boards) - num(a.boards));
    return out;
  }

  function renderTransferDrivers(container, drivers) {
    container.innerHTML = '';
    if (!drivers || drivers.length === 0) return;

    drivers.forEach(d => {
      const det = document.createElement('details');
      det.className = 'driverAcc';

      const groups = groupDriverItemsByPickup(d.items || []);
      const preview = groups.slice(0,3).map(g => `${g.pickup} > ${g.toLine}`).join(' ï½œ ');

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="driverTop">
          <div class="driverName">ğŸšš ${safeText(d.driver)}</div>
          <div class="driverPreview">${preview || ''}</div>
        </div>
        <div class="chips">
          <div class="chip">è¶Ÿæ•¸ï¼š${num(d.count)}</div>
          <div class="chip">ç¸½ç‰ˆæ•¸ï¼š${num(d.totalBoards)}</div>
        </div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'driverBody';

      groups.forEach(g => {
        const box = document.createElement('div');
        box.className = 'routeGroup';

        box.innerHTML = `
          <div class="routeGroupTitle">
            <div class="t">${safeText(g.pickup)}  &nbsp;>&nbsp;  ${safeText(g.toLine)}</div>
            <div class="n">${num(g.subtotal)} ç‰ˆ</div>
          </div>
          <div class="routeGroupList"></div>
        `;

        const listEl = box.querySelector('.routeGroupList');
        const mergedList = mergeSameRoute(g.list || []);

        (mergedList || []).forEach(t => {
          const tag = (t.grade || '').toUpperCase() || 'S';
          const metaParts = [];
          if (t.carNo) metaParts.push(`è»Šè™Ÿ:${safeText(t.carNo)}`);
          if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
          if (t.note) metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
          const sub = metaParts.join(' ï½œ ');

          const task = document.createElement('div');
          task.className = 'task';
          task.innerHTML = `
            <div class="tag ${gradeClass(tag)}">${tag}</div>
            <div class="route">
              <div class="main">${safeText(t.pickup)} â†’ ${safeText(t.dropoff)}</div>
              <div class="sub">${sub || ''}</div>
            </div>
            <div class="boards">${num(t.boards)} ç‰ˆ</div>
          `;
          listEl.appendChild(task);
        });

        body.appendChild(box);
      });

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== Area Drivers render (NEW) =====
  // âœ… é è¦½åªé¡¯ç¤ºï¼šæè²¨é»(E) â†’ æ”¶ä»¶äººå§“å(K)
  // âœ… é»é–‹æ‰é¡¯ç¤ºåœ°å€ï¼šå€é…æè²¨åœ°å€(H) / å€é…æ”¶ä»¶äººåœ°å€(I)
  function renderAreaDrivers(container, drivers) {
    container.innerHTML = '';
    if (!drivers || drivers.length === 0) return;

    // drivers: [{ driver, count, totalBoards, items:[...] }]
    drivers.forEach(d => {
      const det = document.createElement('details');
      det.className = 'driverAcc';

      const dName = stripTrailingDigits(d.driver);
      const dSeq  = trailingSeq(d.driver);

      // é è¦½ï¼šæŠ“å‰ä¸‰ç­†ï¼ˆç”¨é †åº/seq æ’ï¼‰
      const items = (d.items || []).slice().sort((a,b)=>{
        const sa = (a.seq != null) ? Number(a.seq) : 999999;
        const sb = (b.seq != null) ? Number(b.seq) : 999999;
        if (sa !== sb) return sa - sb;
        return num(b.boards) - num(a.boards);
      });

      const preview = items.slice(0,3).map(x => {
        const pick = safeText(x.pickup) || '(æœªå¡«æè²¨)';
        const recv = safeText(x.receiverName) || '(æœªå¡«æ”¶ä»¶äºº)';
        const s = (x.seq != null) ? `#${x.seq} ` : '';
        return `${s}${pick} â†’ ${recv}`;
      }).join(' ï½œ ');

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="driverTop">
          <div class="driverName">ğŸŸ£ ${safeText(dName)} ${dSeq ? `<span class="badgeArea">çµ„åˆ¥/å°¾ç¢¼ ${dSeq}</span>` : `<span class="badgeArea">å€é…</span>`}</div>
          <div class="driverPreview">${preview || ''}</div>
        </div>
        <div class="chips">
          <div class="chip">ç­†æ•¸ï¼š${num(d.count)}</div>
          <div class="chip">ç¸½ç‰ˆæ•¸ï¼š${num(d.totalBoards)}</div>
        </div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'driverBody';

      // ä¾é †åºåˆ†çµ„ï¼šåŒä¸€æè²¨å€‰(E) æ”¾ä¸€èµ·ï¼ˆå¥½æ‰¾ï¼‰
      const byPickup = new Map();
      items.forEach(x=>{
        const k = safeText(x.pickup) || '(æœªå¡«æè²¨)';
        if (!byPickup.has(k)) byPickup.set(k, []);
        byPickup.get(k).push(x);
      });

      for (const [pickup, list] of byPickup.entries()){
        // é€™çµ„å°ç›’
        const box = document.createElement('div');
        box.className = 'routeGroup';

        const subtotal = list.reduce((s,x)=>s+num(x.boards),0);

        box.innerHTML = `
          <div class="routeGroupTitle">
            <div class="t">${safeText(pickup)} <span class="badgeArea">å€é…</span></div>
            <div class="n">${num(subtotal)} ç‰ˆ</div>
          </div>
          <div class="routeGroupList"></div>
        `;

        const listEl = box.querySelector('.routeGroupList');

        list.forEach(x=>{
          const tag = (safeText(x.grade).toUpperCase() === 'H') ? 'H' : 'S';

          const recvName = safeText(x.receiverName) || '(æœªå¡«æ”¶ä»¶äºº)';
          const pickAddr = safeText(x.pickupAddr) || '';
          const recvAddr = safeText(x.receiverAddr) || '';

          // ä¸»åˆ—ï¼šä¸è¦åœ°å€ï¼Œåªè¦ Kï¼ˆæ”¶ä»¶äººå§“åï¼‰
          const main = `${safeText(x.pickup)} â†’ ${recvName}`;

          // subï¼šè»Šè™Ÿ/è²¨ä¸»/å‚™è¨»ï¼ˆè·Ÿè½‰é‹ä¸€è‡´ï¼‰
          const meta = [];
          if (x.carNo) meta.push(`è»Šè™Ÿ:${safeText(x.carNo)}`);
          if (x.owner) meta.push(`è²¨ä¸»:${safeText(x.owner)}`);
          if (x.note)  meta.push(`å‚™è¨»:${safeText(x.note)}`);
          const sub1 = meta.join(' ï½œ ');

          // é»é–‹åœ°å€ï¼ˆdetailsï¼‰
          const addrDet = document.createElement('details');
          addrDet.className = 'acc';
          addrDet.style.marginTop = '6px';

          const seqBadge = (x.seq != null) ? `<span class="seq">#${x.seq}</span>` : `<span class="seq">#-</span>`;

          addrDet.innerHTML = `
            <summary>
              <div class="sumLeft">
                <div class="sumTitle">${seqBadge}ã€€æŸ¥çœ‹åœ°å€</div>
                <div class="sumSub">é»é–‹çœ‹ï¼šå€é…æè²¨åœ°å€ / æ”¶ä»¶äººåœ°å€</div>
              </div>
              <div class="sumRight"></div>
            </summary>
            <div class="accBody">
              <div class="miniRow">
                <div class="miniLeft">
                  <div class="miniTitle">ğŸ“ å€é…æè²¨åœ°å€</div>
                  <div class="miniSub">${pickAddr || '(æœªå¡«)'}</div>
                </div>
              </div>
              <div class="miniRow">
                <div class="miniLeft">
                  <div class="miniTitle">ğŸ æ”¶ä»¶äººåœ°å€</div>
                  <div class="miniSub">${recvAddr || '(æœªå¡«)'}</div>
                </div>
              </div>
            </div>
          `;

          const task = document.createElement('div');
          task.className = 'task area';
          task.innerHTML = `
            <div class="tag ${gradeClass(tag)}">${tag}</div>
            <div class="route">
              <div class="main">${main}</div>
              <div class="sub">${sub1 || ''}</div>
            </div>
            <div class="boards">${num(x.boards)} ç‰ˆ</div>
          `;

          // æŠŠåœ°å€ details æ’åœ¨ task å¾Œé¢ï¼ˆä½†ä»åœ¨åŒ group list è£¡ï¼‰
          const wrap = document.createElement('div');
          wrap.appendChild(task);
          wrap.appendChild(addrDet);

          listEl.appendChild(wrap);
        });

        body.appendChild(box);
      }

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== Load =====
  function loadTabsThenDefault() {
    setLoading(true);
    google.script.run
      .withSuccessHandler((tabs) => {
        const sel = el('dateSelect');
        sel.innerHTML = '';
        (tabs || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        if (sel.options.length > 0) sel.selectedIndex = sel.options.length - 1;

        setLoading(false);
        loadDaily();
      })
      .withFailureHandler((err) => {
        setLoading(false);
        el('subtitle').textContent = 'è®€å–åˆ†é å¤±æ•—ï¼š' + (err?.message || err);
      })
      .getDateTabs();
  }

  function loadDaily() {
    const date = el('dateSelect').value;
    if (!date) return;

    setLoading(true);
    google.script.run
      .withSuccessHandler((data) => {
        setLoading(false);
        el('subtitle').textContent = `ğŸ“… ä»Šæ—¥è»Šè¶Ÿï¼š${data.date}`;

        const pivot = (data.block1?.pickupToDropAll || []);
        el('noAnnounce').style.display = pivot.length ? 'none' : 'block';
        renderAnnounce(el('announce'), pivot);

        const ownerByDir = buildOwnerByDir(pivot);
        el('noKpi').style.display = 'none';
        renderKpis(el('kpiStack'), data.totals || {}, ownerByDir);

        // è½‰é‹
        const drivers = (data.block2?.transferDrivers || []);
        el('noTransferDrivers').style.display = drivers.length ? 'none' : 'block';
        renderTransferDrivers(el('transferDrivers'), drivers);

        // å€é…ï¼ˆâš ï¸ ä½  GAS ä¸‹ä¸€æ­¥æœƒå›å‚³ block2.areaDriversï¼‰
        const area = (data.block2?.areaDrivers || []);
        el('noAreaDrivers').style.display = area.length ? 'none' : 'block';
        renderAreaDrivers(el('areaDrivers'), area);
      })
      .withFailureHandler((err) => {
        setLoading(false);
        el('subtitle').textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (err?.message || err);
      })
      .getDailyTrips(date);
  }

  el('btnLoad').addEventListener('click', loadDaily);
  el('dateSelect').addEventListener('change', loadDaily);

  loadTabsThenDefault();
</script>
</body>
</html>


