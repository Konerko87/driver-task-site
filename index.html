<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>

  <style>
    /* =========================
       0) å¼·åˆ¶è®“ details å¯é»å¯å±•é–‹
       ========================= */
    /* æœ‰äº› Styles æœƒç”¨ pseudo/overlay è“‹ä½é»æ“Šï¼Œé€™è£¡ç¡¬æ•‘ */
    details, summary { position: relative; }
    summary { z-index: 50; pointer-events: auto !important; }
    details > * { pointer-events: auto; }
    .accBody, .driverBody { position: relative; z-index: 10; }

    /* å¦‚æœ Styles æœ‰å¡ç‰‡é‚Šæ¡†çš„ :before/:after è“‹ä½ */
    .card::before, .card::after,
    .topbar::before, .topbar::after{
      pointer-events: none !important;
    }

    /* ===== FIX: å€é… UI çˆ†ç‰ˆï¼ˆå­—è®Šç›´æ’ï¼‰ ===== */
    .driverAcc summary,
    .kpiAcc summary,
    .acc summary{
      align-items:flex-start;
    }

    .driverTop{min-width:0;}
    .driverName{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:560px;
    }
    .driverPreview{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:560px;
    }

    .routeGroupTitle{gap:10px;}
    .routeGroupTitle .t{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* task grid ä¸­é–“æ¬„ä½å…è¨±ç¸®å°ï¼Œé¿å…è¢«æ“ æˆç›´æ’ */
    .task .route{min-width:0;}
    .task .route .main{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .task .route .sub{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* å€é… task æ˜¯ details + summaryï¼šsummary å…§ grid ä¹Ÿè¦å…è¨±ç¸®å° */
    .areaTaskSummary .route{min-width:0;}
    .areaTaskSummary .route .main{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .areaTaskSummary .route .sub{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .areaAddr .miniSub{
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.35;
    }

    /* âœ… FIX: å€é…æ¯ç­†ç”¨ details æ™‚ï¼Œä¸è¦åƒåˆ° .task çš„ grid è¦å‰‡ */
    .taskAcc{
      display:block;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      overflow:hidden;
    }
    .taskAcc summary{
      padding:8px 10px;
      display:grid;
      grid-template-columns:56px 1fr 70px;
      gap:8px;
      align-items:center;
    }
    .taskAcc summary .route{min-width:0;}
    .taskAcc summary .route .main{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .taskAcc summary .route .sub{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* 4 å€é…æ¿å¡Šæ¨™é¡Œé¡è‰²å¾®èª¿ï¼ˆå¯æœ‰å¯ç„¡ï¼‰ */
    .zoneTitle { display:flex; align-items:center; gap:8px; }
    .zonePill {
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      opacity:.92;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>æ¯æ—¥è»Šè¶Ÿå…¬å‘Šæ¿</h1>
        <div class="sub" id="subtitle">è¼‰å…¥ä¸­â€¦</div>
      </div>
      <div class="spacer"></div>

      <label class="hint">é¸æ“‡æ—¥æœŸåˆ†é </label>
      <select id="dateSelect"></select>
      <button id="btnLoad">ç”¢ç”Ÿ</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ“£ ä»Šæ—¥å…¬å‘Šï¼ˆè½‰é‹ + å€é…ï¼‰</h2>

        <div class="topSplit">
          <!-- LEFT -->
          <div class="box">
            <div class="boxTitle"><span class="ico">ğŸ“Œ</span>é‡æ„Ÿï¼ˆé»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆï¼‰</div>
            <div class="kpiStack" id="kpiStack"></div>
            <div class="empty" id="noKpi" style="display:none;">æ²’æœ‰ KPI è³‡æ–™</div>
          </div>

          <!-- RIGHT -->
          <div class="box">
            <div class="boxTitle"><span class="ico">ğŸšš</span>è½‰é‹æé…è³‡è¨Š</div>
            <div id="announce"></div>
            <div class="empty" id="noAnnounce" style="display:none;">æ²’æœ‰å…¬å‘Šè³‡æ–™</div>
          </div>
        </div>
      </div>

      <!-- Transfer Drivers -->
      <div class="card">
        <h2>ğŸšš è½‰é‹å¸æ©Ÿï¼ˆæ”¶åˆçœ‹æè²¨>å€åŸŸï¼Œé»é–‹çœ‹æ¯æ¢ Eâ†’Fï¼‰</h2>
        <div class="driverGrid" id="transferDrivers"></div>
        <div class="empty" id="noTransferDrivers" style="display:none;">å°šæœªå¡«è½‰é‹å¸æ©Ÿå§“åæˆ–ä»Šæ—¥ç„¡è½‰é‹å¸æ©Ÿè³‡æ–™</div>
      </div>

      <!-- Area 4 zones -->
      <div class="card">
        <h2 class="zoneTitle">ğŸŸ£ åŒ—å€é… <span class="zonePill">ä¾ F åˆ°è²¨å€‰å€åŸŸ</span></h2>
        <div class="driverGrid" id="areaNorthDrivers"></div>
        <div class="empty" id="noAreaNorthDrivers" style="display:none;">ä»Šæ—¥ç„¡åŒ—å€é…è³‡æ–™</div>
      </div>

      <div class="card">
        <h2 class="zoneTitle">ğŸŸ£ ä¸­å€é… <span class="zonePill">ä¾ F åˆ°è²¨å€‰å€åŸŸ</span></h2>
        <div class="driverGrid" id="areaMidDrivers"></div>
        <div class="empty" id="noAreaMidDrivers" style="display:none;">ä»Šæ—¥ç„¡ä¸­å€é…è³‡æ–™</div>
      </div>

      <div class="card">
        <h2 class="zoneTitle">ğŸŸ£ é›²å€é… <span class="zonePill">ä¾ F åˆ°è²¨å€‰å€åŸŸ</span></h2>
        <div class="driverGrid" id="areaYunDrivers"></div>
        <div class="empty" id="noAreaYunDrivers" style="display:none;">ä»Šæ—¥ç„¡é›²å€é…è³‡æ–™</div>
      </div>

      <div class="card">
        <h2 class="zoneTitle">ğŸŸ£ å—å€é… <span class="zonePill">ä¾ F åˆ°è²¨å€‰å€åŸŸ</span></h2>
        <div class="driverGrid" id="areaSouthDrivers"></div>
        <div class="empty" id="noAreaSouthDrivers" style="display:none;">ä»Šæ—¥ç„¡å—å€é…è³‡æ–™</div>
      </div>

    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const safeText = (v) => (v === null || v === undefined) ? '' : String(v);
  const num = (v) => Number(v || 0);

  function setLoading(on) {
    el('btnLoad').disabled = on;
    el('btnLoad').textContent = on ? 'è¼‰å…¥ä¸­â€¦' : 'ç”¢ç”Ÿ';
  }

  function gradeClass(g){
    if (g === 'H') return 'h';
    if (g === 'S') return 's';
    return 'n';
  }

  // ====== name helpers (ignore digits) ======
  function displayNameNoDigits(name){
    return safeText(name).replace(/[0-9ï¼-ï¼™]/g,'').trim();
  }

  // âœ… å¿½ç•¥ placeholderï¼ˆä¾‹å¦‚ #999999ï¼‰
  function cleanReceiverLabel(v){
    const s = safeText(v).trim();
    if (!s) return '';
    if (s.startsWith('#')) return '';
    if (s === '999999') return '';
    return s;
  }

  // ===== å€‰åˆ¥å°ç…§ map helpersï¼ˆå‰ç«¯ä¹Ÿåšä¸€ä»½ï¼Œé˜²æ­¢è³‡æ–™æ€ªï¼‰ =====
  function normalizeWarehouseKey(s){
    return safeText(s).trim().replace(/\s+/g,'').toLowerCase();
  }

  function regionByMap(raw, map){
    const s = safeText(raw).trim();
    if (!s) return 'ä¸æ˜';

    const key = normalizeWarehouseKey(s);
    if (map && map[key]) return map[key];

    // fuzzy includes
    if (map) {
      for (const k in map){
        if (!k) continue;
        if (key.includes(k)) return map[k];
      }
    }

    // fallback
    if (s.includes('åŒ—')) return 'åŒ—';
    if (s.includes('ä¸­')) return 'ä¸­';
    if (s.includes('é›²')) return 'é›²';
    if (s.includes('å—')) return 'å—';
    return 'ä¸æ˜';
  }

  // region helpersï¼ˆå³ä¸Šå…¬å‘Šç›®å‰ä»ç”¨ dropoff å­—ä¸²åˆ¤æ–·ï¼‰
  function regionOf(s){
    const v = safeText(s).trim();
    if (!v) return 'ä¸æ˜';
    if (v.includes('åŒ—')) return 'åŒ—';
    if (v.includes('å—')) return 'å—';
    if (v.includes('ä¸­')) return 'ä¸­';
    if (v.includes('é›²')) return 'é›²';
    return 'ä¸æ˜';
  }

  function uniq(arr){
    const out = [];
    const seen = new Set();
    (arr || []).forEach(x=>{
      const k = safeText(x).trim();
      if (!k) return;
      if (seen.has(k)) return;
      seen.add(k);
      out.push(k);
    });
    return out;
  }

  function formatDropBreakdown(drops){
    return (drops || [])
      .filter(x => safeText(x.dropoff).trim())
      .map(x => `${safeText(x.dropoff)} ${num(x.boards)}ç‰ˆ`)
      .join(' / ');
  }

  // ===== RIGHT (announce) =====
  function renderAnnounce(container, pivotArr) {
    container.innerHTML = '';
    if (!pivotArr || pivotArr.length === 0) return;

    pivotArr.forEach(group => {
      const det = document.createElement('details');
      det.className = 'acc';

      const pickup = safeText(group.pickup);

      const toRegionsAll = uniq((group.items || []).map(x => regionOf(x.dropoff)));
      const toRegions = toRegionsAll.filter(r => r !== 'ä¸æ˜');
      const toLine = toRegions.length ? toRegions.join(' / ') : 'ä¸æ˜';

      const dropCount = (group.items || []).length;

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="sumLeft">
          <div class="sumTitle">${pickup}  &nbsp;>&nbsp;  ${toLine}</div>
          <div class="sumSub">é€è²¨é»ï¼š${dropCount} å€‹ï¼ˆé»é–‹çœ‹æ˜ç´°/è²¨ä¸»ï¼‰</div>
        </div>
        <div class="sumRight">${num(group.subtotal)} ç‰ˆ</div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'accBody';

      (group.items || []).forEach(x => {
        const r = document.createElement('div');
        r.className = 'palletRow';
        r.innerHTML = `
          <div class="palletLeft">
            <span class="palletIcon">ğŸ§±</span>
            <div class="palletText">${safeText(x.dropoff)}</div>
          </div>
          <div class="palletNum">${num(x.boards)} ç‰ˆ</div>
        `;
        body.appendChild(r);
      });

      const div = document.createElement('div');
      div.className = 'divider';
      body.appendChild(div);

      if (group.ownerDropItems && group.ownerDropItems.length){
        (group.ownerDropItems || []).forEach(x => {
          const r = document.createElement('div');
          r.className = 'miniRow';
          r.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ§± ${safeText(x.owner)}ã€€æŠµé”å€‰åº«ï¼š${formatDropBreakdown(x.drops)}</div>
            </div>
            <div class="miniNum">å…± ${num(x.totalBoards)} ç‰ˆ</div>
          `;
          body.appendChild(r);
        });
      } else {
        (group.ownerItems || []).forEach(x => {
          const r = document.createElement('div');
          r.className = 'miniRow';
          r.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ§± ${safeText(x.owner)}</div>
            </div>
            <div class="miniNum">${num(x.boards)} ç‰ˆ</div>
          `;
          body.appendChild(r);
        });
      }

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== LEFT: KPI =====
  function buildOwnerByDir(pivotArr){
    const dirs = { north:new Map(), south:new Map(), local:new Map(), unknown:new Map() };

    (pivotArr || []).forEach(g => {
      // é€™æ®µæ²¿ç”¨ä½ åŸæœ¬çš„æ–¹å‘åˆ¤æ–·ï¼ˆä¹‹å¾Œä½ è‹¥è¦æ”¹æˆå€‰åˆ¥å°ç…§å†åšï¼‰
      const from = regionOf(g.pickup);
      const toRegions = uniq((g.items || []).map(x => regionOf(x.dropoff)));

      let bucket = 'unknown';
      if (from === 'åŒ—' && (toRegions.includes('å—') || toRegions.includes('ä¸­') || toRegions.includes('é›²'))) bucket = 'south';
      else if ((from === 'å—' || from === 'ä¸­' || from === 'é›²') && (toRegions.includes('åŒ—'))) bucket = 'north';
      else if (from !== 'ä¸æ˜' && toRegions.length === 1 && toRegions[0] === from) bucket = 'local';
      else bucket = 'unknown';

      (g.ownerItems || []).forEach(o => {
        const name = safeText(o.owner) || '(æœªå¡«è²¨ä¸»)';
        dirs[bucket].set(name, (dirs[bucket].get(name) || 0) + num(o.boards));
      });
    });

    const toArr = (m) => Array.from(m.entries())
      .map(([owner, boards])=>({owner, boards}))
      .sort((a,b)=>b.boards-a.boards);

    return {
      north: toArr(dirs.north),
      south: toArr(dirs.south),
      local: toArr(dirs.local),
      unknown: toArr(dirs.unknown),
    };
  }

  function makeKpiAcc(label, value, hint, ownerList){
    const det = document.createElement('details');
    det.className = 'kpiAcc';

    const sum = document.createElement('summary');
    sum.innerHTML = `
      <div class="kpiLeft">
        <div class="kpiLabel">${safeText(label)}</div>
        <div class="kpiHint">${safeText(hint || 'é»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆ')}</div>
      </div>
      <div class="kpiVal">${num(value)}</div>
    `;
    det.appendChild(sum);

    if (ownerList && ownerList.length){
      const body = document.createElement('div');
      body.className = 'accBody';
      ownerList.slice(0, 20).forEach(x => {
        const r = document.createElement('div');
        r.className = 'miniRow';
        r.innerHTML = `
          <div class="miniLeft">
            <div class="miniTitle">${safeText(x.owner)}</div>
          </div>
          <div class="miniNum">${num(x.boards)} ç‰ˆ</div>
        `;
        body.appendChild(r);
      });
      det.appendChild(body);
    }
    return det;
  }

  function renderKpis(container, totals, ownerByDir){
    container.innerHTML = '';

    // ä½ æœ€æ–°éœ€æ±‚è¦æŠŠã€Œå€åŸŸé…é€ã€æ‹†å››å€‹ KPI
    const hintTotal = `åŒ—ä¸Š:${num(totals.north)}ï½œå—ä¸‹:${num(totals.south)}ï½œå€é…:${num(totals.localTotal)}`;

    container.appendChild(makeKpiAcc('ğŸ“¦ å…¬å‘Šç¸½é‡ï¼ˆç‰ˆï¼‰', totals.totalBoards, hintTotal, []));
    container.appendChild(makeKpiAcc('â¬† åŒ—ä¸Šï¼ˆç‰ˆï¼‰', totals.north, 'é»é–‹çœ‹ï¼šåŒ—ä¸Šè²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.north));
    container.appendChild(makeKpiAcc('â¬‡ å—ä¸‹ï¼ˆç‰ˆï¼‰', totals.south, 'é»é–‹çœ‹ï¼šå—ä¸‹è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.south));

    // âœ… 4 å€é… KPIï¼ˆè‹¥ Code.gs æœ‰å›å‚³ areaNorth/areaMid/areaYun/areaSouth å°±æœƒé¡¯ç¤ºæ­£ç¢ºï¼‰
    container.appendChild(makeKpiAcc('ğŸŸ£ åŒ—å€é…ï¼ˆç‰ˆï¼‰', totals.areaNorth || 0, 'é»é–‹çœ‹ï¼šåŒ—å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));
    container.appendChild(makeKpiAcc('ğŸŸ£ ä¸­å€é…ï¼ˆç‰ˆï¼‰', totals.areaMid || 0, 'é»é–‹çœ‹ï¼šä¸­å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));
    container.appendChild(makeKpiAcc('ğŸŸ£ é›²å€é…ï¼ˆç‰ˆï¼‰', totals.areaYun || 0, 'é»é–‹çœ‹ï¼šé›²å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));
    container.appendChild(makeKpiAcc('ğŸŸ£ å—å€é…ï¼ˆç‰ˆï¼‰', totals.areaSouth || 0, 'é»é–‹çœ‹ï¼šå—å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));

    container.appendChild(makeKpiAcc('âšª ç„¡æ³•åˆ¤æ–·ï¼ˆç‰ˆï¼‰', totals.unknown, 'é»é–‹çœ‹ï¼šä¸æ˜è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.unknown));
    container.appendChild(makeKpiAcc('ğŸš› è½‰é‹ç¸½é‡ï¼ˆç‰ˆï¼‰', totals.transferTotal, 'ï¼ˆç¸½é‡è³‡è¨Šï¼‰', []));
    container.appendChild(makeKpiAcc('ğŸ§© å€é…ç¸½é‡ï¼ˆç‰ˆï¼‰', totals.localTotal, 'ï¼ˆç¸½é‡è³‡è¨Šï¼‰', []));
  }

  // ===== Transfer Drivers =====
  function groupDriverItemsByPickup(items){
    const m = new Map();
    (items || []).forEach(t => {
      const k = safeText(t.pickup);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });

    return Array.from(m.entries()).map(([pickup, list]) => {
      const toRegionsAll = uniq(list.map(x => regionOf(x.dropoff)));
      const toRegions = toRegionsAll.filter(r => r !== 'ä¸æ˜');
      const toLine = toRegions.length ? toRegions.join(' / ') : 'ä¸æ˜';
      return {
        pickup,
        toLine,
        subtotal: list.reduce((s,x)=>s+num(x.boards),0),
        list
      };
    }).sort((a,b)=>b.subtotal-a.subtotal);
  }

  function mergeSameRoute(list){
    const map = new Map();
    (list || []).forEach(t => {
      const pickup = safeText(t.pickup);
      const dropoff = safeText(t.dropoff);
      const key = pickup + 'â†’' + dropoff;

      if (!map.has(key)) {
        map.set(key, {
          pickup,
          dropoff,
          boards: 0,
          grade: 'S',
          carNos: new Set(),
          owners: new Set(),
          notes: new Set()
        });
      }
      const g = map.get(key);

      g.boards += num(t.boards);

      const tg = (safeText(t.grade).toUpperCase() || 'S');
      if (tg === 'H') g.grade = 'H';

      const carNo = safeText(t.carNo).trim();
      if (carNo) g.carNos.add(carNo);

      const owner = safeText(t.owner).trim();
      if (owner) g.owners.add(owner);

      const note = safeText(t.note).trim();
      if (note) g.notes.add(note);
    });

    const out = Array.from(map.values()).map(x => ({
      pickup: x.pickup,
      dropoff: x.dropoff,
      boards: x.boards,
      grade: x.grade,
      carNo: Array.from(x.carNos).join('ã€'),
      owner: Array.from(x.owners).join('ã€'),
      note: Array.from(x.notes).join('ï½œ')
    }));

    out.sort((a,b)=> num(b.boards) - num(a.boards));
    return out;
  }

  function renderTransferDrivers(container, drivers) {
    container.innerHTML = '';
    if (!drivers || drivers.length === 0) return;

    // âœ… è‹¥ Code.gs æœ‰å›å‚³ driverSeqï¼Œå°±ç…§ seq æ’ï¼›å¦å‰‡ç…§ totalBoards
    const list = (drivers || []).slice().sort((a,b)=>{
      const sa = (a.driverSeq==null)?999999:Number(a.driverSeq);
      const sb = (b.driverSeq==null)?999999:Number(b.driverSeq);
      if (sa !== sb) return sa - sb;
      return num(b.totalBoards) - num(a.totalBoards);
    });

    list.forEach(d => {
      const det = document.createElement('details');
      det.className = 'driverAcc';

      const groups = groupDriverItemsByPickup(d.items || []);
      const preview = groups.slice(0,3).map(g => `${g.pickup} > ${g.toLine}`).join(' ï½œ ');

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="driverTop">
          <div class="driverName">ğŸšš ${displayNameNoDigits(d.driver)}</div>
          <div class="driverPreview">${preview || ''}</div>
        </div>
        <div class="chips">
          <div class="chip">ç­†æ•¸ï¼š${num(d.count)}</div>
          <div class="chip">ç¸½ç‰ˆæ•¸ï¼š${num(d.totalBoards)}</div>
        </div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'driverBody';

      groups.forEach(g => {
        const box = document.createElement('div');
        box.className = 'routeGroup';

        box.innerHTML = `
          <div class="routeGroupTitle">
            <div class="t">${safeText(g.pickup)}  &nbsp;>&nbsp;  ${safeText(g.toLine)}</div>
            <div class="n">${num(g.subtotal)} ç‰ˆ</div>
          </div>
          <div class="routeGroupList"></div>
        `;

        const listEl = box.querySelector('.routeGroupList');
        const mergedList = mergeSameRoute(g.list || []);

        (mergedList || []).forEach(t => {
          const tag = (t.grade || '').toUpperCase() || 'S';
          const metaParts = [];
          if (t.carNo) metaParts.push(`è»Šè™Ÿ:${safeText(t.carNo)}`);
          if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
          if (t.note) metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
          const sub = metaParts.join(' ï½œ ');

          const task = document.createElement('div');
          task.className = 'task';
          task.innerHTML = `
            <div class="tag ${gradeClass(tag)}">${tag}</div>
            <div class="route">
              <div class="main">${safeText(t.pickup)} â†’ ${safeText(t.dropoff)}</div>
              <div class="sub">${sub || ''}</div>
            </div>
            <div class="boards">${num(t.boards)} ç‰ˆ</div>
          `;
          listEl.appendChild(task);
        });

        body.appendChild(box);
      });

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== Area Drivers (render) =====
  function groupAreaItemsByPickup(items){
    const m = new Map();
    (items || []).forEach(t => {
      const k = safeText(t.pickup); // E
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });

    return Array.from(m.entries()).map(([pickup, list]) => {
      const previewTo = uniq(list.map(x => {
        const lbl = cleanReceiverLabel(x.dropLabel) || cleanReceiverLabel(x.receiver) || cleanReceiverLabel(x.dropoff);
        return lbl || '(æœªå¡«æ”¶ä»¶äºº)';
      }));
      const toLine = previewTo.slice(0,3).join(' / ') + (previewTo.length>3 ? ' â€¦' : '');
      return {
        pickup,
        toLine: toLine || '',
        subtotal: list.reduce((s,x)=>s+num(x.boards),0),
        list
      };
    }).sort((a,b)=>b.subtotal-a.subtotal);
  }

  function renderAreaDrivers(container, drivers) {
    container.innerHTML = '';
    if (!drivers || drivers.length === 0) return;

    // âœ… è‹¥ Code.gs æœ‰ driverSeqï¼Œç…§ seq æ’ï¼›å¦å‰‡ totalBoards
    const list = (drivers || []).slice().sort((a,b)=>{
      const sa = (a.driverSeq==null)?999999:Number(a.driverSeq);
      const sb = (b.driverSeq==null)?999999:Number(b.driverSeq);
      if (sa !== sb) return sa - sb;
      return num(b.totalBoards) - num(a.totalBoards);
    });

    list.forEach(d => {
      const det = document.createElement('details');
      det.className = 'driverAcc';

      const groups = groupAreaItemsByPickup(d.items || []);
      const preview = groups.slice(0,3).map(g => `${g.pickup} > ${g.toLine}`).join(' ï½œ ');

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="driverTop">
          <div class="driverName">ğŸŸ£ ${displayNameNoDigits(d.driver)}</div>
          <div class="driverPreview">${preview || ''}</div>
        </div>
        <div class="chips">
          <div class="chip">ç­†æ•¸ï¼š${num(d.count)}</div>
          <div class="chip">ç¸½ç‰ˆæ•¸ï¼š${num(d.totalBoards)}</div>
        </div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'driverBody';

      groups.forEach(g => {
        const box = document.createElement('div');
        box.className = 'routeGroup';

        box.innerHTML = `
          <div class="routeGroupTitle">
            <div class="t">${safeText(g.pickup)}  &nbsp;>&nbsp;  ${safeText(g.toLine)}</div>
            <div class="n">${num(g.subtotal)} ç‰ˆ</div>
          </div>
          <div class="routeGroupList"></div>
        `;

        const listEl = box.querySelector('.routeGroupList');

        // å€é…ï¼šä¾ seq æ’åºï¼ˆæ²’æœ‰ seq æ”¾æœ€å¾Œï¼‰
        const listSorted = (g.list || []).slice().sort((a,b)=>{
          const sa = (a.seq === null || a.seq === undefined) ? 999999 : Number(a.seq);
          const sb = (b.seq === null || b.seq === undefined) ? 999999 : Number(b.seq);
          if (sa !== sb) return sa - sb;
          return num(b.boards) - num(a.boards);
        });

        listSorted.forEach(t => {
          const tag = (safeText(t.grade).toUpperCase() || 'S');
          const metaParts = [];
          if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
          if (t.note)  metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
          const sub = metaParts.join(' ï½œ ');

          const recv = cleanReceiverLabel(t.receiver) || cleanReceiverLabel(t.dropLabel) || cleanReceiverLabel(t.dropoff) || '(æœªå¡«æ”¶ä»¶äºº)';
          const seqTxt = (t.seq !== null && t.seq !== undefined) ? `é †åº ${t.seq}ï¼š` : '';
          const mainLine = `${seqTxt}${safeText(t.pickup)} â†’ ${recv}`;

          const task = document.createElement('details');
          task.className = 'taskAcc';

          task.innerHTML = `
            <summary class="areaTaskSummary">
              <div class="tag ${gradeClass(tag)}">${tag}</div>
              <div class="route">
                <div class="main">${mainLine}</div>
                <div class="sub">${sub || ''}</div>
              </div>
              <div class="boards">${num(t.boards)} ç‰ˆ</div>
            </summary>

            <div class="accBody areaAddr" style="padding:10px;border-top:1px solid rgba(255,255,255,.08);">
              <div class="miniRow">
                <div class="miniLeft">
                  <div class="miniTitle">ğŸ“ å€é…æè²¨åœ°é»ï¼ˆFï¼‰</div>
                  <div class="miniSub">${safeText(t.pickupAddr || '')}</div>
                </div>
              </div>

              <div class="miniRow">
                <div class="miniLeft">
                  <div class="miniTitle">ğŸ æ”¶ä»¶äººåœ°å€ï¼ˆIï¼‰</div>
                  <div class="miniSub">${safeText(t.recvAddr || '')}</div>
                </div>
              </div>
            </div>
          `;
          listEl.appendChild(task);
        });

        body.appendChild(box);
      });

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== æŠŠ areaDrivers æ‹†æˆ åŒ—/ä¸­/é›²/å— å››å€ï¼ˆä¾ F åˆ°è²¨å€‰åˆ¤æ–·ï¼‰ =====
  function splitAreaDriversByZone(areaDrivers, whMap){
    const out = { north: [], mid: [], yun: [], south: [] };

    (areaDrivers || []).forEach(d => {
      const items = d.items || [];

      const buckets = { north: [], mid: [], yun: [], south: [] };

      items.forEach(it => {
        // âœ… ä¾ä½  Code.gsï¼špickupAddr æœƒå¡ Fï¼ˆåˆ°è²¨å€‰ï¼‰ï¼ŒæŠ“å®ƒåˆ¤æ–·å€åŸŸ
        const ref = safeText(it.pickupAddr || it.dropoff || '');
        const r = regionByMap(ref, whMap);

        if (r === 'åŒ—') buckets.north.push(it);
        else if (r === 'ä¸­') buckets.mid.push(it);
        else if (r === 'é›²') buckets.yun.push(it);
        else if (r === 'å—') buckets.south.push(it);
      });

      function pushIfAny(key, list){
        if (!list.length) return;
        const totalBoards = list.reduce((s,x)=>s+num(x.boards),0);
        out[key].push({
          driver: d.driver,
          driverSeq: d.driverSeq ?? null,
          count: list.length,
          totalBoards,
          items: list
        });
      }

      pushIfAny('north', buckets.north);
      pushIfAny('mid', buckets.mid);
      pushIfAny('yun', buckets.yun);
      pushIfAny('south', buckets.south);
    });

    // æ¯å€å…§æ’åºï¼ˆå…ˆçœ‹ driverSeqï¼Œæ²’æœ‰å°± totalBoardsï¼‰
    for (const k of ['north','mid','yun','south']){
      out[k].sort((a,b)=>{
        const sa = (a.driverSeq==null)?999999:Number(a.driverSeq);
        const sb = (b.driverSeq==null)?999999:Number(b.driverSeq);
        if (sa !== sb) return sa - sb;
        return num(b.totalBoards) - num(a.totalBoards);
      });
    }

    return out;
  }

  // =========================
  // Global details toggle guardï¼ˆæœ€çµ‚ä¿éšªï¼‰
  // =========================
  function installDetailsClickGuard(){
    document.addEventListener('click', (ev) => {
      const sum = ev.target.closest && ev.target.closest('summary');
      if (!sum) return;

      const det = sum.parentElement;
      if (!det || det.tagName !== 'DETAILS') return;

      // âœ… å¼·åˆ¶åˆ‡æ› open
      ev.preventDefault();
      ev.stopPropagation();
      det.open = !det.open;
    }, true); // capture
  }

  // =========================
  // Load tabs & daily
  // =========================
  function loadTabsThenDefault() {
    setLoading(true);
    google.script.run
      .withSuccessHandler((tabs) => {
        const sel = el('dateSelect');
        sel.innerHTML = '';
        (tabs || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        if (sel.options.length > 0) sel.selectedIndex = sel.options.length - 1;

        setLoading(false);
        loadDaily();
      })
      .withFailureHandler((err) => {
        setLoading(false);
        el('subtitle').textContent = 'è®€å–åˆ†é å¤±æ•—ï¼š' + (err?.message || err);
      })
      .getDateTabs();
  }

  function loadDaily() {
    const date = el('dateSelect').value;
    if (!date) return;

    setLoading(true);
    google.script.run
      .withSuccessHandler((data) => {
        setLoading(false);
        el('subtitle').textContent = `ğŸ“… ä»Šæ—¥è»Šè¶Ÿï¼š${data.date}`;

        const pivot = (data.block1.pickupToDropAll || []);
        el('noAnnounce').style.display = pivot.length ? 'none' : 'block';
        renderAnnounce(el('announce'), pivot);

        const ownerByDir = buildOwnerByDir(pivot);
        el('noKpi').style.display = 'none';
        renderKpis(el('kpiStack'), data.totals, ownerByDir);

        // Transfer
        const tDrivers = (data.block2.transferDrivers || []);
        el('noTransferDrivers').style.display = tDrivers.length ? 'none' : 'block';
        renderTransferDrivers(el('transferDrivers'), tDrivers);

        // Area -> 4 zones
        const whMap = data.warehouseRegionMap || {};
        const aDrivers = (data.block2.areaDrivers || []);
        const zones = splitAreaDriversByZone(aDrivers, whMap);

        el('noAreaNorthDrivers').style.display = zones.north.length ? 'none' : 'block';
        el('noAreaMidDrivers').style.display   = zones.mid.length ? 'none' : 'block';
        el('noAreaYunDrivers').style.display   = zones.yun.length ? 'none' : 'block';
        el('noAreaSouthDrivers').style.display = zones.south.length ? 'none' : 'block';

        renderAreaDrivers(el('areaNorthDrivers'), zones.north);
        renderAreaDrivers(el('areaMidDrivers'),   zones.mid);
        renderAreaDrivers(el('areaYunDrivers'),   zones.yun);
        renderAreaDrivers(el('areaSouthDrivers'), zones.south);
      })
      .withFailureHandler((err) => {
        setLoading(false);
        el('subtitle').textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (err?.message || err);
      })
      .getDailyTrips(date);
  }

  el('btnLoad').addEventListener('click', loadDaily);
  el('dateSelect').addEventListener('change', loadDaily);

  // start
  installDetailsClickGuard();
  loadTabsThenDefault();
</script>
</body>
</html>

