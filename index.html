<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>

  <!-- âœ… ä¸æ”¹ Styles æª”ä¹Ÿèƒ½æ•‘ UI -->
  <style>
    /* ===== FIX: summary é»ä¸åˆ° / çˆ†ç‰ˆ ===== */
    .topbar:before, .card:before { pointer-events:none !important; }

    .driverAcc summary,
    .kpiAcc summary,
    .acc summary{
      align-items:flex-start;
    }

    .driverTop{min-width:0;}
    .driverName{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:560px;
    }
    .driverPreview{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:560px;
    }

    .routeGroupTitle{gap:10px;}
    .routeGroupTitle .t{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .task .route{min-width:0;}
    .task .route .main{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .task .route .sub{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* âœ… å€é…æ¯ç­†ç”¨ details æ™‚ï¼Œä¸è¦åƒåˆ° .task çš„ grid è¦å‰‡ */
    .taskAcc{
      display:block;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      overflow:hidden;
    }
    .taskAcc summary{
      padding:8px 10px;
      display:grid;
      grid-template-columns:56px 1fr 70px;
      gap:8px;
      align-items:center;
    }
    .taskAcc summary .route{min-width:0;}
    .taskAcc summary .route .main{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .taskAcc summary .route .sub{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .areaAddr .miniSub{
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.35;
    }

    /* âœ… ä¿éšªï¼šè®“ details/summary æ°¸é å¯é» */
    details.acc summary,
    details.kpiAcc summary,
    details.driverAcc summary,
    details.taskAcc summary{
      position:relative;
      z-index:2;
      pointer-events:auto;
    }
    details.acc, details.kpiAcc, details.driverAcc, details.taskAcc{
      position:relative;
      z-index:1;
    }

    /* å››å€é…æ¨™é¡Œå° chips */
    .segHeader{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin: 6px 0 10px;
    }
    .segChip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      opacity:.95;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>æ¯æ—¥è»Šè¶Ÿå…¬å‘Šæ¿</h1>
        <div class="sub" id="subtitle">è¼‰å…¥ä¸­â€¦</div>
      </div>
      <div class="spacer"></div>

      <label class="hint">é¸æ“‡æ—¥æœŸåˆ†é </label>
      <select id="dateSelect"></select>
      <button id="btnLoad">ç”¢ç”Ÿ</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ“£ ä»Šæ—¥å…¬å‘Šï¼ˆè½‰é‹ + å€é…ï¼‰</h2>

        <div class="topSplit">
          <!-- LEFT -->
          <div class="box">
            <div class="boxTitle"><span class="ico">ğŸ“Œ</span>é‡æ„Ÿï¼ˆé»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆï¼‰</div>
            <div class="kpiStack" id="kpiStack"></div>
            <div class="empty" id="noKpi" style="display:none;">æ²’æœ‰ KPI è³‡æ–™</div>
          </div>

          <!-- RIGHT -->
          <div class="box">
            <div class="boxTitle"><span class="ico">ğŸšš</span>è½‰é‹æé…è³‡è¨Š</div>
            <div id="announce"></div>
            <div class="empty" id="noAnnounce" style="display:none;">æ²’æœ‰å…¬å‘Šè³‡æ–™</div>

            <div class="divider" style="margin:12px 0;"></div>

            <div class="boxTitle"><span class="ico">ğŸŸ£</span>å€é…å…¬å‘Šï¼ˆä¾ F åˆ†å€ï¼‰</div>
            <div id="areaAnnounce"></div>
            <div class="empty" id="noAreaAnnounce" style="display:none;">æ²’æœ‰å€é…å…¬å‘Šè³‡æ–™</div>
          </div>
        </div>
      </div>

      <!-- Transfer Drivers -->
      <div class="card">
        <h2>ğŸšš è½‰é‹å¸æ©Ÿï¼ˆæ”¶åˆçœ‹æè²¨>å€åŸŸï¼Œé»é–‹çœ‹æ¯æ¢ Eâ†’Fï¼‰</h2>
        <div class="driverGrid" id="transferDrivers"></div>
        <div class="empty" id="noTransferDrivers" style="display:none;">å°šæœªå¡«è½‰é‹å¸æ©Ÿå§“åæˆ–ä»Šæ—¥ç„¡è½‰é‹å¸æ©Ÿè³‡æ–™</div>
      </div>

      <!-- Area Drivers - split into 4 blocks -->
      <div class="card">
        <h2>ğŸŸ£ åŒ—å€é…ï¼ˆä¾ F å€åŸŸï¼‰</h2>
        <div class="segHeader" id="segNorth"></div>
        <div class="driverGrid" id="areaDriversNorth"></div>
        <div class="empty" id="noAreaDriversNorth" style="display:none;">ä»Šæ—¥ç„¡åŒ—å€é…è³‡æ–™</div>
      </div>

      <div class="card">
        <h2>ğŸŸ£ ä¸­å€é…ï¼ˆä¾ F å€åŸŸï¼‰</h2>
        <div class="segHeader" id="segMid"></div>
        <div class="driverGrid" id="areaDriversMid"></div>
        <div class="empty" id="noAreaDriversMid" style="display:none;">ä»Šæ—¥ç„¡ä¸­å€é…è³‡æ–™</div>
      </div>

      <div class="card">
        <h2>ğŸŸ£ é›²å€é…ï¼ˆä¾ F å€åŸŸï¼‰</h2>
        <div class="segHeader" id="segYun"></div>
        <div class="driverGrid" id="areaDriversYun"></div>
        <div class="empty" id="noAreaDriversYun" style="display:none;">ä»Šæ—¥ç„¡é›²å€é…è³‡æ–™</div>
      </div>

      <div class="card">
        <h2>ğŸŸ£ å—å€é…ï¼ˆä¾ F å€åŸŸï¼‰</h2>
        <div class="segHeader" id="segSouth"></div>
        <div class="driverGrid" id="areaDriversSouth"></div>
        <div class="empty" id="noAreaDriversSouth" style="display:none;">ä»Šæ—¥ç„¡å—å€é…è³‡æ–™</div>
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const safeText = (v) => (v === null || v === undefined) ? '' : String(v);
  const num = (v) => Number(v || 0);

  function setLoading(on) {
    el('btnLoad').disabled = on;
    el('btnLoad').textContent = on ? 'è¼‰å…¥ä¸­â€¦' : 'ç”¢ç”Ÿ';
  }

  function gradeClass(g){
    if (g === 'H') return 'h';
    if (g === 'S') return 's';
    return 'n';
  }

  // ====== name helpers (ignore digits) ======
  function displayNameNoDigits(name){
    return safeText(name).replace(/[0-9ï¼-ï¼™]/g,'').trim();
  }

  // âœ… å¿½ç•¥ placeholderï¼ˆä¾‹å¦‚ #999999ï¼‰
  function cleanReceiverLabel(v){
    const s = safeText(v).trim();
    if (!s) return '';
    if (s.startsWith('#')) return '';
    if (s === '999999') return '';
    return s;
  }

  function uniq(arr){
    const out = [];
    const seen = new Set();
    (arr || []).forEach(x=>{
      const k = safeText(x).trim();
      if (!k) return;
      if (seen.has(k)) return;
      seen.add(k);
      out.push(k);
    });
    return out;
  }

  // ========= å€‰åˆ¥å°ç…§ï¼ˆä¾†è‡ª Code.gs å›å‚³ warehouseRegionMapï¼‰ =========
  function normalizeWhKey(s){
    return safeText(s).trim().replace(/\s+/g,'').toLowerCase();
  }

  function regionByMap(wh, map){
    const raw = safeText(wh).trim();
    if (!raw) return 'ä¸æ˜';
    const key = normalizeWhKey(raw);
    if (map && map[key]) return map[key];

    // fuzzy contains
    if (map){
      for (const k in map){
        if (!k) continue;
        if (key.includes(k)) return map[k];
      }
    }

    // fallback
    if (raw.includes('åŒ—')) return 'åŒ—';
    if (raw.includes('ä¸­')) return 'ä¸­';
    if (raw.includes('é›²')) return 'é›²';
    if (raw.includes('å—')) return 'å—';
    return 'ä¸æ˜';
  }

  function regionLabelForArea(r){
    if (r === 'åŒ—') return 'åŒ—å€é…';
    if (r === 'ä¸­') return 'ä¸­å€é…';
    if (r === 'é›²') return 'é›²å€é…';
    if (r === 'å—') return 'å—å€é…';
    return 'ä¸æ˜';
  }

  // ===== RIGHT (transfer announce) =====
  function formatDropBreakdown(drops){
    return (drops || [])
      .filter(x => safeText(x.dropoff).trim())
      .map(x => `${safeText(x.dropoff)} ${num(x.boards)}ç‰ˆ`)
      .join(' / ');
  }

  function regionOfSimpleText(s){
    const v = safeText(s).trim();
    if (!v) return 'ä¸æ˜';
    if (v.includes('åŒ—')) return 'åŒ—';
    if (v.includes('ä¸­')) return 'ä¸­';
    if (v.includes('é›²')) return 'é›²';
    if (v.includes('å—')) return 'å—';
    return 'ä¸æ˜';
  }

  function renderAnnounce(container, pivotArr, whMap) {
    container.innerHTML = '';
    if (!pivotArr || pivotArr.length === 0) return;

    pivotArr.forEach(group => {
      const det = document.createElement('details');
      det.className = 'acc';

      const pickup = safeText(group.pickup);

      // toRegions = ä¾ dropoff çš„å€åŸŸï¼ˆæœ‰å€‰åˆ¥å°ç…§å°±ç”¨å°ç…§ï¼‰
      const toRegionsAll = uniq((group.items || []).map(x => regionByMap(x.dropoff, whMap)));
      const toRegions = toRegionsAll.filter(r => r !== 'ä¸æ˜');
      const toLine = toRegions.length ? toRegions.join(' / ') : 'ä¸æ˜';

      const dropCount = (group.items || []).length;

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="sumLeft">
          <div class="sumTitle">${pickup}  &nbsp;>&nbsp;  ${toLine}</div>
          <div class="sumSub">é€è²¨é»ï¼š${dropCount} å€‹ï¼ˆé»é–‹çœ‹æ˜ç´°/è²¨ä¸»ï¼‰</div>
        </div>
        <div class="sumRight">${num(group.subtotal)} ç‰ˆ</div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'accBody';

      (group.items || []).forEach(x => {
        const r = document.createElement('div');
        r.className = 'palletRow';
        r.innerHTML = `
          <div class="palletLeft">
            <span class="palletIcon">ğŸ§±</span>
            <div class="palletText">${safeText(x.dropoff)}</div>
          </div>
          <div class="palletNum">${num(x.boards)} ç‰ˆ</div>
        `;
        body.appendChild(r);
      });

      const div = document.createElement('div');
      div.className = 'divider';
      body.appendChild(div);

      if (group.ownerDropItems && group.ownerDropItems.length){
        (group.ownerDropItems || []).forEach(x => {
          const r = document.createElement('div');
          r.className = 'miniRow';
          r.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ§± ${safeText(x.owner)}ã€€æŠµé”å€‰åº«ï¼š${formatDropBreakdown(x.drops)}</div>
            </div>
            <div class="miniNum">å…± ${num(x.totalBoards)} ç‰ˆ</div>
          `;
          body.appendChild(r);
        });
      } else {
        (group.ownerItems || []).forEach(x => {
          const r = document.createElement('div');
          r.className = 'miniRow';
          r.innerHTML = `
            <div class="miniLeft">
              <div class="miniTitle">ğŸ§± ${safeText(x.owner)}</div>
            </div>
            <div class="miniNum">${num(x.boards)} ç‰ˆ</div>
          `;
          body.appendChild(r);
        });
      }

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== RIGHT (area announce) =====
  function buildAreaAnnounceFromDrivers(areaDrivers, whMap){
    const buckets = {
      'åŒ—': { total:0, ownerMap:new Map(), whMap:new Map() },
      'ä¸­': { total:0, ownerMap:new Map(), whMap:new Map() },
      'é›²': { total:0, ownerMap:new Map(), whMap:new Map() },
      'å—': { total:0, ownerMap:new Map(), whMap:new Map() },
      'ä¸æ˜': { total:0, ownerMap:new Map(), whMap:new Map() },
    };

    (areaDrivers || []).forEach(d=>{
      (d.items || []).forEach(it=>{
        const wh = safeText(it.pickup || it.pickupAddr || '').trim(); // ä½ å€é…å·²æ”¹æˆ F
        const rg = regionByMap(wh, whMap);
        const b = num(it.boards);
        const owner = safeText(it.owner).trim() || '(æœªå¡«è²¨ä¸»)';

        const bucket = buckets[rg] ? rg : 'ä¸æ˜';
        buckets[bucket].total += b;

        buckets[bucket].ownerMap.set(owner, (buckets[bucket].ownerMap.get(owner)||0) + b);
        if (wh) buckets[bucket].whMap.set(wh, (buckets[bucket].whMap.get(wh)||0) + b);
      });
    });

    function topListFromMap(m, limit){
      return Array.from(m.entries())
        .map(([k,v])=>({k,v}))
        .sort((a,b)=>b.v-a.v)
        .slice(0, limit);
    }

    return { buckets, topListFromMap };
  }

  function renderAreaAnnounce(container, areaDrivers, whMap){
    container.innerHTML = '';
    if (!areaDrivers || !areaDrivers.length) return;

    const { buckets, topListFromMap } = buildAreaAnnounceFromDrivers(areaDrivers, whMap);

    const order = ['åŒ—','ä¸­','é›²','å—','ä¸æ˜'];
    order.forEach(rg=>{
      const b = buckets[rg];
      if (!b || b.total <= 0) return;

      const det = document.createElement('details');
      det.className = 'acc';

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="sumLeft">
          <div class="sumTitle">${rg==='ä¸æ˜'?'âšª ä¸æ˜å€é…':('ğŸŸ£ '+regionLabelForArea(rg))}</div>
          <div class="sumSub">é»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆ / å€‰åˆ¥ â†’ å¹¾ç‰ˆ</div>
        </div>
        <div class="sumRight">${num(b.total)} ç‰ˆ</div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'accBody';

      // å€‰åˆ¥ breakdown
      topListFromMap(b.whMap, 10).forEach(x=>{
        const row = document.createElement('div');
        row.className = 'miniRow';
        row.innerHTML = `
          <div class="miniLeft"><div class="miniTitle">ğŸ“¦ ${safeText(x.k)}</div></div>
          <div class="miniNum">${num(x.v)} ç‰ˆ</div>
        `;
        body.appendChild(row);
      });

      const div = document.createElement('div');
      div.className = 'divider';
      body.appendChild(div);

      // è²¨ä¸» breakdown
      topListFromMap(b.ownerMap, 20).forEach(x=>{
        const row = document.createElement('div');
        row.className = 'miniRow';
        row.innerHTML = `
          <div class="miniLeft"><div class="miniTitle">ğŸ§± ${safeText(x.k)}</div></div>
          <div class="miniNum">${num(x.v)} ç‰ˆ</div>
        `;
        body.appendChild(row);
      });

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== LEFT: KPI =====
  function buildOwnerByDir(pivotArr, whMap){
    const dirs = { north:new Map(), south:new Map(), unknown:new Map() };

    (pivotArr || []).forEach(g => {
      const from = regionByMap(g.pickup, whMap);
      const toRegions = uniq((g.items || []).map(x => regionByMap(x.dropoff, whMap)));

      let bucket = 'unknown';
      // ä½ è¦å‰‡ï¼šE=åŒ— => å—ä¸‹ï¼›E=å—/ä¸­/é›² => åŒ—ä¸Š
      if (from === 'åŒ—') bucket = 'south';
      else if (from === 'å—' || from === 'ä¸­' || from === 'é›²') bucket = 'north';
      else bucket = 'unknown';

      (g.ownerItems || []).forEach(o => {
        const name = safeText(o.owner) || '(æœªå¡«è²¨ä¸»)';
        dirs[bucket].set(name, (dirs[bucket].get(name) || 0) + num(o.boards));
      });
    });

    const toArr = (m) => Array.from(m.entries())
      .map(([owner, boards])=>({owner, boards}))
      .sort((a,b)=>b.boards-a.boards);

    return {
      north: toArr(dirs.north),
      south: toArr(dirs.south),
      unknown: toArr(dirs.unknown),
    };
  }

  function makeKpiAcc(label, value, hint, ownerList){
    const det = document.createElement('details');
    det.className = 'kpiAcc';

    const sum = document.createElement('summary');
    sum.innerHTML = `
      <div class="kpiLeft">
        <div class="kpiLabel">${safeText(label)}</div>
        <div class="kpiHint">${safeText(hint || 'é»é–‹çœ‹ï¼šè²¨ä¸» â†’ å¹¾ç‰ˆ')}</div>
      </div>
      <div class="kpiVal">${num(value)}</div>
    `;
    det.appendChild(sum);

    if (ownerList && ownerList.length){
      const body = document.createElement('div');
      body.className = 'accBody';
      ownerList.slice(0, 20).forEach(x => {
        const r = document.createElement('div');
        r.className = 'miniRow';
        r.innerHTML = `
          <div class="miniLeft">
            <div class="miniTitle">${safeText(x.owner)}</div>
          </div>
          <div class="miniNum">${num(x.boards)} ç‰ˆ</div>
        `;
        body.appendChild(r);
      });
      det.appendChild(body);
    }
    return det;
  }

  function renderKpis(container, totals, ownerByDir){
    container.innerHTML = '';

    // ç¸½é‡
    container.appendChild(
      makeKpiAcc(
        'ğŸ“¦ å…¬å‘Šç¸½é‡ï¼ˆç‰ˆï¼‰',
        totals.totalBoards,
        `åŒ—ä¸Š:${num(totals.north)}ï½œå—ä¸‹:${num(totals.south)}ï½œå€é…:${num(totals.localTotal)}`,
        []
      )
    );

    container.appendChild(makeKpiAcc('â¬† åŒ—ä¸Šï¼ˆç‰ˆï¼‰', totals.north, 'é»é–‹çœ‹ï¼šåŒ—ä¸Šè²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.north));
    container.appendChild(makeKpiAcc('â¬‡ å—ä¸‹ï¼ˆç‰ˆï¼‰', totals.south, 'é»é–‹çœ‹ï¼šå—ä¸‹è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.south));

    // âœ… å€é…æ‹†å››å€
    container.appendChild(makeKpiAcc('ğŸŸ£ åŒ—å€é…ï¼ˆç‰ˆï¼‰', totals.areaNorth || 0, 'é»é–‹çœ‹ï¼šåŒ—å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));
    container.appendChild(makeKpiAcc('ğŸŸ£ ä¸­å€é…ï¼ˆç‰ˆï¼‰', totals.areaMid || 0, 'é»é–‹çœ‹ï¼šä¸­å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));
    container.appendChild(makeKpiAcc('ğŸŸ£ é›²å€é…ï¼ˆç‰ˆï¼‰', totals.areaYun || 0, 'é»é–‹çœ‹ï¼šé›²å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));
    container.appendChild(makeKpiAcc('ğŸŸ£ å—å€é…ï¼ˆç‰ˆï¼‰', totals.areaSouth || 0, 'é»é–‹çœ‹ï¼šå—å€é…è²¨ä¸» â†’ å¹¾ç‰ˆ', []));

    container.appendChild(makeKpiAcc('âšª ç„¡æ³•åˆ¤æ–·ï¼ˆç‰ˆï¼‰', totals.unknown, 'é»é–‹çœ‹ï¼šä¸æ˜è²¨ä¸» â†’ å¹¾ç‰ˆ', ownerByDir.unknown));
    container.appendChild(makeKpiAcc('ğŸš› è½‰é‹ç¸½é‡ï¼ˆç‰ˆï¼‰', totals.transferTotal, 'ï¼ˆç¸½é‡è³‡è¨Šï¼‰', []));
    container.appendChild(makeKpiAcc('ğŸ§© å€é…ç¸½é‡ï¼ˆç‰ˆï¼‰', totals.localTotal, 'ï¼ˆç¸½é‡è³‡è¨Šï¼‰', []));
  }

  // ===== Transfer Drivers =====
  function groupDriverItemsByPickup(items, whMap){
    const m = new Map();
    (items || []).forEach(t => {
      const k = safeText(t.pickup);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });

    return Array.from(m.entries()).map(([pickup, list]) => {
      const toRegionsAll = uniq(list.map(x => regionByMap(x.dropoff, whMap)));
      const toRegions = toRegionsAll.filter(r => r !== 'ä¸æ˜');
      const toLine = toRegions.length ? toRegions.join(' / ') : 'ä¸æ˜';
      return {
        pickup,
        toLine,
        subtotal: list.reduce((s,x)=>s+num(x.boards),0),
        list
      };
    }).sort((a,b)=>b.subtotal-a.subtotal);
  }

  function mergeSameRoute(list){
    const map = new Map();
    (list || []).forEach(t => {
      const pickup = safeText(t.pickup);
      const dropoff = safeText(t.dropoff);
      const key = pickup + 'â†’' + dropoff;

      if (!map.has(key)) {
        map.set(key, {
          pickup,
          dropoff,
          boards: 0,
          grade: 'S',
          carNos: new Set(),
          owners: new Set(),
          notes: new Set()
        });
      }
      const g = map.get(key);

      g.boards += num(t.boards);

      const tg = (safeText(t.grade).toUpperCase() || 'S');
      if (tg === 'H') g.grade = 'H';

      const carNo = safeText(t.carNo).trim();
      if (carNo) g.carNos.add(carNo);

      const owner = safeText(t.owner).trim();
      if (owner) g.owners.add(owner);

      const note = safeText(t.note).trim();
      if (note) g.notes.add(note);
    });

    const out = Array.from(map.values()).map(x => ({
      pickup: x.pickup,
      dropoff: x.dropoff,
      boards: x.boards,
      grade: x.grade,
      carNo: Array.from(x.carNos).join('ã€'),
      owner: Array.from(x.owners).join('ã€'),
      note: Array.from(x.notes).join('ï½œ')
    }));

    out.sort((a,b)=> num(b.boards) - num(a.boards));
    return out;
  }

  function renderTransferDrivers(container, drivers, whMap) {
    container.innerHTML = '';
    if (!drivers || drivers.length === 0) return;

    // è½‰é‹å¸æ©Ÿæ’åºï¼šä¾ã€Œå°¾å·´æ•¸å­—ã€(1,2,3...)ï¼Œæ²’å°¾å·´æ”¾å¾Œé¢
    const driversSorted = (drivers || []).slice().sort((a,b)=>{
      const da = safeText(a.driver);
      const db = safeText(b.driver);
      const ma = da.match(/(\d+)$/);
      const mb = db.match(/(\d+)$/);
      const sa = ma ? Number(ma[1]) : 999999;
      const sb = mb ? Number(mb[1]) : 999999;
      if (sa !== sb) return sa - sb;
      return safeText(da).localeCompare(safeText(db), 'zh-Hant');
    });

    driversSorted.forEach(d => {
      const det = document.createElement('details');
      det.className = 'driverAcc';

      const groups = groupDriverItemsByPickup(d.items || [], whMap);
      const preview = groups.slice(0,3).map(g => `${g.pickup} > ${g.toLine}`).join(' ï½œ ');

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="driverTop">
          <div class="driverName">ğŸšš ${displayNameNoDigits(d.driver)}</div>
          <div class="driverPreview">${preview || ''}</div>
        </div>
        <div class="chips">
          <div class="chip">ç­†æ•¸ï¼š${num(d.count)}</div>
          <div class="chip">ç¸½ç‰ˆæ•¸ï¼š${num(d.totalBoards)}</div>
        </div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'driverBody';

      groups.forEach(g => {
        const box = document.createElement('div');
        box.className = 'routeGroup';

        box.innerHTML = `
          <div class="routeGroupTitle">
            <div class="t">${safeText(g.pickup)}  &nbsp;>&nbsp;  ${safeText(g.toLine)}</div>
            <div class="n">${num(g.subtotal)} ç‰ˆ</div>
          </div>
          <div class="routeGroupList"></div>
        `;

        const listEl = box.querySelector('.routeGroupList');
        const mergedList = mergeSameRoute(g.list || []);

        (mergedList || []).forEach(t => {
          const tag = (t.grade || '').toUpperCase() || 'S';
          const metaParts = [];
          if (t.carNo) metaParts.push(`è»Šè™Ÿ:${safeText(t.carNo)}`);
          if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
          if (t.note) metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
          const sub = metaParts.join(' ï½œ ');

          const task = document.createElement('div');
          task.className = 'task';
          task.innerHTML = `
            <div class="tag ${gradeClass(tag)}">${tag}</div>
            <div class="route">
              <div class="main">${safeText(t.pickup)} â†’ ${safeText(t.dropoff)}</div>
              <div class="sub">${sub || ''}</div>
            </div>
            <div class="boards">${num(t.boards)} ç‰ˆ</div>
          `;
          listEl.appendChild(task);
        });

        body.appendChild(box);
      });

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== Area Drivers (render) =====
  function groupAreaItemsByPickup(items){
    const m = new Map();
    (items || []).forEach(t => {
      const k = safeText(t.pickup);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });

    return Array.from(m.entries()).map(([pickup, list]) => {
      const previewTo = uniq(list.map(x => {
        const lbl = cleanReceiverLabel(x.dropLabel) || cleanReceiverLabel(x.receiver) || cleanReceiverLabel(x.dropoff);
        return lbl || '(æœªå¡«æ”¶ä»¶äºº)';
      }));
      const toLine = previewTo.slice(0,3).join(' / ') + (previewTo.length>3 ? ' â€¦' : '');
      return {
        pickup,
        toLine: toLine || '',
        subtotal: list.reduce((s,x)=>s+num(x.boards),0),
        list
      };
    }).sort((a,b)=>b.subtotal-a.subtotal);
  }

  function renderAreaDrivers(container, drivers, labelPrefix) {
    container.innerHTML = '';
    if (!drivers || drivers.length === 0) return;

    // å€é…å¸æ©Ÿæ’åºï¼šä¾ seq å°¾å·´ï¼ˆ1,2,3...ï¼‰
    const driversSorted = (drivers || []).slice().sort((a,b)=>{
      const da = safeText(a.driver);
      const db = safeText(b.driver);
      const ma = da.match(/(\d+)$/);
      const mb = db.match(/(\d+)$/);
      const sa = ma ? Number(ma[1]) : 999999;
      const sb = mb ? Number(mb[1]) : 999999;
      if (sa !== sb) return sa - sb;
      return safeText(da).localeCompare(safeText(db), 'zh-Hant');
    });

    driversSorted.forEach(d => {
      const det = document.createElement('details');
      det.className = 'driverAcc';

      const groups = groupAreaItemsByPickup(d.items || []);
      const preview = groups.slice(0,3).map(g => `${g.pickup} > ${g.toLine}`).join(' ï½œ ');

      const sum = document.createElement('summary');
      sum.innerHTML = `
        <div class="driverTop">
          <div class="driverName">ğŸŸ£ ${labelPrefix} ${displayNameNoDigits(d.driver)}</div>
          <div class="driverPreview">${preview || ''}</div>
        </div>
        <div class="chips">
          <div class="chip">ç­†æ•¸ï¼š${num(d.count)}</div>
          <div class="chip">ç¸½ç‰ˆæ•¸ï¼š${num(d.totalBoards)}</div>
        </div>
      `;
      det.appendChild(sum);

      const body = document.createElement('div');
      body.className = 'driverBody';

      groups.forEach(g => {
        const box = document.createElement('div');
        box.className = 'routeGroup';

        box.innerHTML = `
          <div class="routeGroupTitle">
            <div class="t">${safeText(g.pickup)}  &nbsp;>&nbsp;  ${safeText(g.toLine)}</div>
            <div class="n">${num(g.subtotal)} ç‰ˆ</div>
          </div>
          <div class="routeGroupList"></div>
        `;

        const listEl = box.querySelector('.routeGroupList');

        const listSorted = (g.list || []).slice().sort((a,b)=>{
          const sa = (a.seq === null || a.seq === undefined) ? 999999 : Number(a.seq);
          const sb = (b.seq === null || b.seq === undefined) ? 999999 : Number(b.seq);
          if (sa !== sb) return sa - sb;
          return num(b.boards) - num(a.boards);
        });

        listSorted.forEach(t => {
          const tag = (safeText(t.grade).toUpperCase() || 'S');
          const metaParts = [];
          if (t.owner) metaParts.push(`è²¨ä¸»:${safeText(t.owner)}`);
          if (t.note)  metaParts.push(`å‚™è¨»:${safeText(t.note)}`);
          const sub = metaParts.join(' ï½œ ');

          const recv = cleanReceiverLabel(t.receiver) || cleanReceiverLabel(t.dropLabel) || cleanReceiverLabel(t.dropoff) || '(æœªå¡«æ”¶ä»¶äºº)';
          const seqTxt = (t.seq !== null && t.seq !== undefined) ? `é †åº ${t.seq}ï¼š` : '';
          const mainLine = `${seqTxt}${safeText(t.pickup)} â†’ ${recv}`;

          const task = document.createElement('details');
          task.className = 'taskAcc';

          task.innerHTML = `
            <summary class="areaTaskSummary">
              <div class="tag ${gradeClass(tag)}">${tag}</div>
              <div class="route">
                <div class="main">${mainLine}</div>
                <div class="sub">${sub || ''}</div>
              </div>
              <div class="boards">${num(t.boards)} ç‰ˆ</div>
            </summary>

            <div class="accBody areaAddr">
              <div class="miniRow">
                <div class="miniLeft">
                  <div class="miniTitle">ğŸ“ å€é…æè²¨åœ°é»ï¼ˆFï¼‰</div>
                  <div class="miniSub">${safeText(t.pickupAddr || t.pickup || '')}</div>
                </div>
              </div>

              <div class="miniRow">
                <div class="miniLeft">
                  <div class="miniTitle">ğŸ æ”¶ä»¶äººåœ°å€ï¼ˆIï¼‰</div>
                  <div class="miniSub">${safeText(t.recvAddr || '')}</div>
                </div>
              </div>
            </div>
          `;
          listEl.appendChild(task);
        });

        body.appendChild(box);
      });

      det.appendChild(body);
      container.appendChild(det);
    });
  }

  // ===== åˆ†å€ï¼šæŠŠ areaDrivers æ‹†æˆ åŒ—/ä¸­/é›²/å— =====
  function splitAreaDriversByRegion(areaDrivers, whMap){
    const out = { ë¶:[], mid:[], yun:[], south:[] };
    const buckets = { 'åŒ—':[], 'ä¸­':[], 'é›²':[], 'å—':[] };

    (areaDrivers || []).forEach(d=>{
      // æŠŠåŒä¸€å€‹å¸æ©Ÿçš„ items ä¾å€‰åˆ¥åˆ†å€åˆ‡é–‹
      const bMap = { 'åŒ—':[], 'ä¸­':[], 'é›²':[], 'å—':[] };
      (d.items || []).forEach(it=>{
        const wh = safeText(it.pickup || it.pickupAddr || '').trim();
        const rg = regionByMap(wh, whMap);
        if (bMap[rg]) bMap[rg].push(it);
      });

      Object.keys(bMap).forEach(rg=>{
        if (!bMap[rg].length) return;
        const items = bMap[rg];

        // é‡ç®— count/totalBoards
        const totalBoards = items.reduce((s,x)=>s+num(x.boards),0);
        buckets[rg].push({
          driver: d.driver,
          count: items.length,
          totalBoards,
          items
        });
      });
    });

    return buckets;
  }

  function renderSegHeader(elId, title, total){
    const box = el(elId);
    box.innerHTML = '';
    const chip = document.createElement('div');
    chip.className = 'segChip';
    chip.textContent = `${title} ç¸½é‡ï¼š${num(total)} ç‰ˆ`;
    box.appendChild(chip);
  }

  // ===== load tabs + daily =====
  function loadTabsThenDefault() {
    setLoading(true);
    google.script.run
      .withSuccessHandler((tabs) => {
        const sel = el('dateSelect');
        sel.innerHTML = '';
        (tabs || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        if (sel.options.length > 0) sel.selectedIndex = sel.options.length - 1;

        setLoading(false);
        loadDaily();
      })
      .withFailureHandler((err) => {
        setLoading(false);
        el('subtitle').textContent = 'è®€å–åˆ†é å¤±æ•—ï¼š' + (err?.message || err);
      })
      .getDateTabs();
  }

  function loadDaily() {
    const date = el('dateSelect').value;
    if (!date) return;

    setLoading(true);
    google.script.run
      .withSuccessHandler((data) => {
        setLoading(false);
        el('subtitle').textContent = `ğŸ“… ä»Šæ—¥è»Šè¶Ÿï¼š${data.date}`;

        const whMap = data.warehouseRegionMap || {};

        // Transfer announce
        const pivot = (data.block1.pickupToDropAll || []);
        el('noAnnounce').style.display = pivot.length ? 'none' : 'block';
        renderAnnounce(el('announce'), pivot, whMap);

        // KPI (å«å››å€é…)
        const ownerByDir = buildOwnerByDir(pivot, whMap);
        el('noKpi').style.display = 'none';
        renderKpis(el('kpiStack'), data.totals, ownerByDir);

        // Transfer drivers
        const tDrivers = (data.block2.transferDrivers || []);
        el('noTransferDrivers').style.display = tDrivers.length ? 'none' : 'block';
        renderTransferDrivers(el('transferDrivers'), tDrivers, whMap);

        // Area announce + area split blocks
        const aDrivers = (data.block2.areaDrivers || []);
        el('noAreaAnnounce').style.display = aDrivers.length ? 'none' : 'block';
        renderAreaAnnounce(el('areaAnnounce'), aDrivers, whMap);

        const buckets = splitAreaDriversByRegion(aDrivers, whMap);

        const northList = buckets['åŒ—'] || [];
        const midList   = buckets['ä¸­'] || [];
        const yunList   = buckets['é›²'] || [];
        const southList = buckets['å—'] || [];

        const sumBoards = (arr)=> (arr||[]).reduce((s,d)=>s+num(d.totalBoards),0);

        renderSegHeader('segNorth', 'åŒ—å€é…', sumBoards(northList));
        renderSegHeader('segMid',   'ä¸­å€é…', sumBoards(midList));
        renderSegHeader('segYun',   'é›²å€é…', sumBoards(yunList));
        renderSegHeader('segSouth', 'å—å€é…', sumBoards(southList));

        el('noAreaDriversNorth').style.display = northList.length ? 'none' : 'block';
        el('noAreaDriversMid').style.display   = midList.length ? 'none' : 'block';
        el('noAreaDriversYun').style.display   = yunList.length ? 'none' : 'block';
        el('noAreaDriversSouth').style.display = southList.length ? 'none' : 'block';

        renderAreaDrivers(el('areaDriversNorth'), northList, 'åŒ—å€é…');
        renderAreaDrivers(el('areaDriversMid'),   midList,   'ä¸­å€é…');
        renderAreaDrivers(el('areaDriversYun'),   yunList,   'é›²å€é…');
        renderAreaDrivers(el('areaDriversSouth'), southList, 'å—å€é…');
      })
      .withFailureHandler((err) => {
        setLoading(false);
        el('subtitle').textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + (err?.message || err);
      })
      .getDailyTrips(date);
  }

  el('btnLoad').addEventListener('click', loadDaily);
  el('dateSelect').addEventListener('change', loadDaily);

  loadTabsThenDefault();

  // âœ… å¿…æ®ºï¼šå¼·åˆ¶è®“å³ä¸Šï¼ˆä»¥åŠæ‰€æœ‰ï¼‰details éƒ½èƒ½å±•é–‹ï¼ˆè§£ã€Œå€é…ä¸èƒ½å±•é–‹ã€ï¼‰
  document.addEventListener('click', (ev) => {
    const sum = ev.target.closest('summary');
    if (!sum) return;
    const det = sum.closest('details');
    if (!det) return;

    // åªè™•ç†æˆ‘å€‘çš„ accordionï¼ˆé¿å…å¹²æ“¾ç€è¦½å™¨å…¶ä»–åŸç”Ÿï¼‰
    if (!(det.classList.contains('acc') || det.classList.contains('kpiAcc') || det.classList.contains('driverAcc') || det.classList.contains('taskAcc'))) return;

    ev.preventDefault();
    ev.stopPropagation();
    det.open = !det.open;
  }, true);
</script>
</body>
</html>



